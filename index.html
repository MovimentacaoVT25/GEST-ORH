<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RH Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== ESTILO VISUAL PREMIUM (RESTAURADO) ===== */
        :root {
            --primary: #2c3e50; --secondary: #34495e; --accent: #3498db;
            --success: #27ae60; --danger: #e74c3c; --warning: #f1c40f;
            --bg: #f4f7f6; --text: #333; --white: #fff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page.active { animation: fadeIn 0.4s ease-out forwards; }

        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 20px; }
        .login-box { background: var(--white); border-radius: var(--radius); box-shadow: 0 20px 50px rgba(0,0,0,0.2); padding: 40px; width: 100%; max-width: 400px; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { font-size: 26px; color: var(--primary); margin-bottom: 5px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--primary); font-weight: 600; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; transition: 0.3s; background: #fff; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52,152,219,0.1); }

        .login-btn { width: 100%; padding: 14px; background: var(--primary); color: var(--white); border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .login-btn:hover { background: var(--secondary); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .login-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .btn-small { padding: 8px 14px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-aprovar { background: var(--success); color: white; }
        .btn-rejeitar { background: var(--danger); color: white; }
        .btn-excel { background: #217346; color: white; } 
        .btn-refresh { background: var(--accent); color: white; }

        .btn-outline { background: white; border: 1px solid #eee; color: var(--primary); font-weight: 600; transition: all 0.2s; width: 100%; text-align: left; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .btn-outline:hover { background: #f8f9fa; border-color: var(--accent); color: var(--accent); transform: translateX(5px); }

        .dashboard-container { display: none; height: 100vh; overflow: hidden; }
        .dashboard-container.active { display: flex; }
        
        .sidebar { width: 240px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 10; }
        .sidebar-title { font-size: 20px; font-weight: 700; margin-bottom: 30px; }
        .sidebar-user { font-size: 12px; opacity: 0.7; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        
        .nav-link { display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.7); text-decoration: none; padding: 12px 15px; border-radius: 8px; font-size: 14px; transition: 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; }
        
        .main-content { flex: 1; background: var(--bg); overflow-y: auto; padding: 30px; }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 26px; font-weight: 700; color: var(--primary); }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .select-periodo { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 13px; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); border-left: 5px solid var(--accent); transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-card.green { border-left-color: var(--success); }
        .kpi-card.orange { border-left-color: var(--warning); }
        .kpi-card.purple { border-left-color: #9b59b6; }
        .kpi-header { display: flex; justify-content: space-between; margin-bottom: 10px; color: #7f8c8d; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .kpi-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .card { background: white; border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 20px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 15px; }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; color: var(--primary); font-weight: 600; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; color: #555; vertical-align: middle; }
        tr:hover td { background: #f9f9f9; }

        .rank-badge { width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: white; background: #bdc3c7; }
        .rank-1 { background: var(--warning); box-shadow: 0 2px 5px rgba(241,196,15,0.4); }
        .rank-2 { background: #95a5a6; }
        .rank-3 { background: #d35400; }
        
        .loading-spinner { display: none; text-align: center; padding: 20px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .ferias-row { cursor: pointer; transition: background 0.2s; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .ferias-row:hover { background-color: #f0f8ff; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; color: white; }
        .status-Pendente { background: #f1c40f; } .status-Aprovada { background: #27ae60; } .status-Rejeitada { background: #e74c3c; } .status-Solicitado { background: #3498db; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: fadeIn 0.3s; }

        @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { width: 70px; padding: 15px; } .sidebar-title, .sidebar-user, .nav-link span { display: none; } .main-content { margin-left: 70px; padding: 20px; } }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header"><h1>RH Manager</h1><p>Sistema de Gest√£o Integrado</p></div>
            <div id="errorMessage" style="display:none; color:var(--danger); background:#fadbd8; padding:10px; border-radius:6px; margin-bottom:15px; font-size:13px; text-align:center;"></div>
            <div id="loadingSpinner" class="loading-spinner"><div class="spinner"></div><p style="margin-top:10px; font-size:12px; color:#666;">Acessando...</p></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group"><label>Email Corporativo</label><input type="email" id="email" required></div>
                <div class="form-group"><label>Senha</label><input type="password" id="password" required></div>
                <button type="submit" class="login-btn" id="loginBtn">ACESSAR SISTEMA</button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-title">RH Manager</div>
            <div class="sidebar-user"><div style="font-weight:bold; color:white;" id="userName">Usu√°rio</div><div id="userEmail" style="opacity:0.7; font-size:11px;">email@empresa.com</div></div>
            <nav>
                <button class="nav-link active" onclick="showPage('dashboard')"><i class="fas fa-home"></i> <span>In√≠cio</span></button>
                <button class="nav-link" onclick="showPage('horas')"><i class="fas fa-clock"></i> <span>Horas Extras</span></button>
                <button class="nav-link" onclick="showPage('aprovacoes')"><i class="fas fa-check-circle"></i> <span>Aprova√ß√µes</span></button>
                <button class="nav-link" onclick="showPage('ferias')"><i class="fas fa-umbrella-beach"></i> <span>F√©rias</span></button>
                <button class="nav-link" onclick="showPage('funcionarios')"><i class="fas fa-users"></i> <span>Funcion√°rios</span></button>
            </nav>
            <button onclick="handleLogout()" class="nav-link" style="color:var(--danger); margin-top:auto;"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></button>
        </aside>

        <main class="main-content">
            <div id="dashboard-page" class="page active">
                <div class="page-header">
                    <div><h1 class="page-title">Ol√°, <span id="dashUserName">Colaborador</span>! üëã</h1><p style="color:#7f8c8d; font-size:14px;">Resumo geral.</p></div>
                    <div style="background:white; padding:10px 20px; border-radius:8px; font-weight:600; color:var(--primary);"><i class="far fa-calendar-alt"></i> <span id="dataAtual">--/--/--</span></div>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card" style="border-left-color: var(--accent);"><div class="kpi-header"><span class="kpi-label">Funcion√°rios</span><i class="fas fa-users" style="color:var(--accent)"></i></div><div class="kpi-value" id="dashTotalFunc">--</div></div>
                    <div class="kpi-card" style="border-left-color: var(--success);"><div class="kpi-header"><span class="kpi-label">Horas (M√™s)</span><i class="fas fa-clock" style="color:var(--success)"></i></div><div class="kpi-value" id="dashHorasExtras">--</div></div>
                    <div class="kpi-card" style="border-left-color: var(--warning);"><div class="kpi-header"><span class="kpi-label">Pend√™ncias</span><i class="fas fa-exclamation-circle" style="color:var(--warning)"></i></div><div class="kpi-value" id="dashPendencias">--</div></div>
                    <div class="kpi-card" style="border-left-color: #9b59b6;"><div class="kpi-header"><span class="kpi-label">F√©rias</span><i class="fas fa-plane" style="color:#9b59b6"></i></div><div class="kpi-value" id="dashFerias">--</div></div>
                </div>
                <div class="content-grid">
                    <div class="card"><h2 class="card-title">Distribui√ß√£o</h2><div style="height:250px;"><canvas id="graficoDashboard"></canvas></div></div>
                    <div class="card"><h2 class="card-title">Acesso R√°pido</h2><div style="display:flex; flex-direction:column; gap:10px;">
                        <button onclick="showPage('ferias')" class="btn-outline"><i class="fas fa-umbrella-beach"></i> Solicitar F√©rias</button>
                        <button onclick="showPage('horas')" class="btn-outline"><i class="fas fa-history"></i> Banco de Horas</button>
                        <button onclick="showPage('funcionarios')" class="btn-outline"><i class="fas fa-user-plus"></i> Novo Funcion√°rio</button>
                    </div></div>
                </div>
            </div>

            <div id="horas-page" class="page">
                <div class="page-header">
                    <h1 class="page-title">Horas Extras</h1>
                    <div class="header-controls">
                        <select id="filtroPeriodo" class="select-periodo" onchange="recarregarHorasExtras()"></select>
                        <button onclick="downloadExcel()" class="btn-small btn-excel"><i class="fas fa-file-excel"></i> Exportar</button>
                        <button onclick="recarregarHorasExtras()" class="btn-small btn-refresh"><i class="fas fa-sync-alt"></i> Atualizar</button>
                    </div>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Total Acumulado</span></div><div class="kpi-value" id="totalHorasExtras">--</div><small id="periodoDisplay" style="color:#7f8c8d;"></small></div>
                    <div class="kpi-card green"><div class="kpi-header"><span class="kpi-label">Maior Saldo</span></div><div class="kpi-value" id="colaboradorMaisHoras">--</div><small id="colaboradorChange" style="display:none; font-weight:bold; color:#666; margin-top:5px;"></small></div>
                </div>
                <div class="content-grid">
                    <div class="card"><h2 class="card-title">Por Setor</h2><div style="height:250px;"><canvas id="graficoHorasPorSetor"></canvas></div></div>
                    <div class="card"><h2 class="card-title">Ranking</h2><div class="table-container"><div id="tabelaColaboradores">Carregando...</div></div></div>
                </div>
            </div>

            <div id="aprovacoes-page" class="page">
                <div class="page-header"><h1 class="page-title">Aprova√ß√µes</h1></div>
                <div id="acessoNegado" style="display:none; text-align:center; padding:40px; background:white; border-radius:12px; margin-bottom:20px;"><p style="color:var(--danger);">Acesso restrito.</p></div>
                <div id="containerAprovacoes" class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <span class="card-title">Solicita√ß√µes Pendentes</span>
                        <button onclick="carregarSolicitacoesPendentes()" class="btn-small btn-refresh"><i class="fas fa-sync"></i></button>
                    </div>
                    <div id="solicitacoesPendentes">Carregando...</div>
                </div>
            </div>

            <div id="ferias-page" class="page">
                <div class="page-header"><h1 class="page-title">Gest√£o de F√©rias</h1><button onclick="abrirConfigEmails()" class="btn-small" style="background:#34495e; color:white;"><i class="fas fa-cog"></i> Configurar E-mails</button></div>
                <div class="content-grid">
                    <div class="card">
                        <h2 class="card-title">Nova Solicita√ß√£o</h2>
                        <form id="formFerias" onsubmit="event.preventDefault(); solicitarFerias();">
                            <div class="form-group"><label>Colaborador</label><select id="feriasNomeColaborador" required><option>Carregando...</option></select></div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                                <div class="form-group"><label>Modelo</label><select id="modeloFerias" onchange="calcularVolta()" required><option value="30">30 dias</option><option value="20_10_venda">20 + Venda</option><option value="20_10_gozo">20 (1¬∫ Per)</option></select></div>
                                <div class="form-group"><label>In√≠cio</label><input type="date" id="dataSaida" onchange="calcularVolta()" required></div>
                            </div>
                            <div id="boxPrevisao" style="background:#fef9e7; padding:10px; border-radius:6px; margin-bottom:15px; display:none; border:1px solid #f1c40f; color:#d35400; font-size:13px;"><strong>Retorno: <span id="textoDataRetorno">--/--/--</span></strong><input type="hidden" id="dataRetornoCalculada"></div>
                            <div class="form-group"><label>Obs</label><textarea id="obsFerias" rows="2"></textarea></div>
                            <button type="submit" id="btnSalvarFerias" class="btn-small btn-aprovar" style="width:100%; padding:12px;">Agendar</button>
                        </form>
                    </div>
                    <div class="card">
                        <h2 class="card-title">Solicita√ß√µes (Todas)</h2>
                        <div id="historicoFeriasContainer">Carregando...</div>
                    </div>
                </div>
            </div>

            <div id="funcionarios-page" class="page">
                <div class="page-header"><h1 class="page-title">Funcion√°rios</h1><button onclick="document.getElementById('modalFuncionario').style.display='flex'" class="btn-small btn-aprovar"><i class="fas fa-plus"></i> Novo</button></div>
                <div class="card"><div id="funcionariosContainer">Carregando...</div></div>
            </div>

            <div id="modalDetalhesFerias" class="modal-overlay">
                <div class="modal-box">
                    <h2 style="margin-bottom:15px; color:var(--primary);">Detalhes</h2>
                    <div id="conteudoDetalhesFerias" style="margin-bottom:20px; line-height:1.6; font-size:14px;"></div>
                    <input type="hidden" id="linhaFeriasAtual">
                    <div style="display:flex; gap:10px;">
                        <button onclick="acaoFerias('Aprovada')" class="btn-small btn-aprovar" style="flex:1;">Aprovar</button>
                        <button onclick="acaoFerias('Rejeitada')" class="btn-small btn-rejeitar" style="flex:1;">Rejeitar</button>
                        <button onclick="document.getElementById('modalDetalhesFerias').style.display='none'" class="btn-small" style="background:#95a5a6; color:white; flex:1;">Fechar</button>
                    </div>
                </div>
            </div>

            <div id="modalConfigEmails" class="modal-overlay">
                <div class="modal-box">
                    <h2 style="margin-bottom:15px;">E-mails Notifica√ß√£o</h2>
                    <p style="font-size:12px; color:#666; margin-bottom:10px;">Separe por v√≠rgula.</p>
                    <textarea id="inputEmailsConfig" rows="4" style="width:100%; border:1px solid #ddd; padding:10px; border-radius:6px; margin-bottom:10px;"></textarea>
                    <button onclick="salvarConfigEmails()" class="btn-small btn-aprovar" style="width:100%;">Salvar</button>
                    <button onclick="document.getElementById('modalConfigEmails').style.display='none'" class="btn-small" style="background:#95a5a6; color:white; width:100%; margin-top:5px;">Fechar</button>
                </div>
            </div>

            <div id="modalFuncionario" class="modal-overlay">
                <div class="modal-box">
                    <h2 style="margin-bottom:20px;">Novo Funcion√°rio</h2>
                    <form onsubmit="event.preventDefault(); salvarFuncionario();">
                        <div class="form-group"><label>Nome</label><input id="inputNome" required></div>
                        <div class="form-group"><label>Cargo</label><input id="inputCargo"></div>
                        <div class="form-group"><label>Setor</label><input id="inputSetor"></div>
                        <div class="form-group"><label>Turno</label><input id="inputTurno"></div>
                        <button type="submit" class="btn-small btn-aprovar" style="width:100%;">Salvar</button>
                        <button type="button" onclick="document.getElementById('modalFuncionario').style.display='none'" class="btn-small btn-rejeitar" style="width:100%; margin-top:5px;">Cancelar</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- ATEN√á√ÉO: SUBSTITUA PELA SUA URL DE IMPLANTA√á√ÉO (NOVA VERS√ÉO) ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxW6J1Wr4CzzWX2wIl38HHn_0_MJLMJ0OtgcWI17bv9p1oOZxoFsaJyblJ_Ya0MjWRW/exec';
        
        const INACTIVITY_TIMEOUT = 300000; 
        let inactivityTimer, dashboardChartInstance = null, horasChartInstance = null;

        function init() { preencherPeriodos(); }

        // PER√çODOS (ATUALIZADO: HOJE >= 20, LIBERA M√äS SEGUINTE)
        function preencherPeriodos() {
            const sel = document.getElementById('filtroPeriodo'); if(!sel) return; sel.innerHTML='';
            const hj = new Date();
            const meses = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
            let offset = (hj.getDate() >= 20) ? 1 : 0;
            for(let i=0; i<12; i++) {
                let d = new Date(hj.getFullYear(), hj.getMonth() + offset - i, 1);
                let opt = document.createElement('option');
                opt.value = `${d.getMonth()}-${d.getFullYear()}`;
                opt.text = `${meses[d.getMonth()]}/${d.getFullYear()}`;
                sel.add(opt);
            }
        }

        // EXCEL DOWNLOAD (.XLS)
        async function downloadExcel() {
            const val = document.getElementById('filtroPeriodo').value;
            if(!val) return alert("Selecione um per√≠odo.");
            const [m,a] = val.split('-');
            const btn = document.querySelector('.btn-excel');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            try {
                const res = await fetch(`${SCRIPT_URL}?action=exportarExcel&mes=${m}&ano=${a}`);
                const data = await res.json();
                if(data.sucesso) {
                    const blob = new Blob(["\ufeff" + data.dados.arquivo], { type: 'application/vnd.ms-excel' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = data.dados.nome;
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                } else alert("Erro: " + data.mensagem);
            } catch(e) { alert("Erro conex√£o."); }
            finally { btn.innerHTML = original; btn.disabled = false; }
        }

        // F√âRIAS (GERENCIAL + EMAIL)
        async function carregarHistoricoFerias() {
            const div = document.getElementById('historicoFeriasContainer');
            div.innerHTML = '<div class="loading-spinner" style="display:block"><div class="spinner"></div></div>';
            try {
                const res = await fetch(`${SCRIPT_URL}?action=obterTodasFerias`);
                const data = await res.json();
                if(data.sucesso && data.dados.length) {
                    let html = '<div style="max-height:300px; overflow-y:auto;">';
                    data.dados.forEach(f => {
                        let dataShow = f.saida.split('-').reverse().join('/');
                        html += `<div class="ferias-row" onclick='abrirDetalhesFerias(${JSON.stringify(f)})'>
                            <div><strong style="color:var(--primary);">${f.colaborador}</strong><br><span style="font-size:11px; color:#777;">In√≠cio: ${dataShow}</span></div>
                            <span class="status-badge status-${f.status}">${f.status}</span>
                        </div>`;
                    });
                    div.innerHTML = html + '</div>';
                } else div.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">Nenhuma solicita√ß√£o.</p>';
            } catch(e) { div.innerHTML = 'Erro ao carregar.'; }
        }
        function abrirDetalhesFerias(f) {
            document.getElementById('linhaFeriasAtual').value = f.linha;
            document.getElementById('conteudoDetalhesFerias').innerHTML = `<p><strong>Colaborador:</strong> ${f.colaborador}</p><p><strong>Modelo:</strong> ${f.modelo}</p><p><strong>Sa√≠da:</strong> ${f.saida.split('-').reverse().join('/')}</p><p><strong>Retorno:</strong> ${f.retorno.split('-').reverse().join('/')}</p><p><strong>Obs:</strong> ${f.obs||'-'}</p><p><strong>Status:</strong> ${f.status}</p>`;
            document.getElementById('modalDetalhesFerias').style.display = 'flex';
        }
        async function acaoFerias(status) {
            const linha = document.getElementById('linhaFeriasAtual').value;
            let motivo = ''; if(status==='Rejeitada') { motivo = prompt("Motivo:"); if(!motivo) return; }
            if(!confirm(`Confirmar ${status}?`)) return;
            document.getElementById('modalDetalhesFerias').style.display = 'none';
            document.getElementById('historicoFeriasContainer').innerHTML = '<div class="spinner"></div> Processando...';
            await fetch(`${SCRIPT_URL}?action=alterarStatusFerias&linha=${linha}&status=${status}&motivo=${encodeURIComponent(motivo)}&emailUser=${localStorage.getItem('userEmail')}`);
            carregarHistoricoFerias();
        }
        async function abrirConfigEmails() {
            const res = await fetch(`${SCRIPT_URL}?action=obterEmailsNotificacao`); const data = await res.json();
            document.getElementById('inputEmailsConfig').value = data.dados.emails;
            document.getElementById('modalConfigEmails').style.display = 'flex';
        }
        async function salvarConfigEmails() {
            const emails = document.getElementById('inputEmailsConfig').value;
            await fetch(`${SCRIPT_URL}?action=salvarEmailsNotificacao&emails=${encodeURIComponent(emails)}`);
            document.getElementById('modalConfigEmails').style.display = 'none'; alert('Salvo!');
        }
        async function solicitarFerias() {
            const btn=document.getElementById('btnSalvarFerias'); btn.disabled=true; btn.textContent='Enviando...';
            try {
                await fetch(`${SCRIPT_URL}?action=agendarFerias&email=${encodeURIComponent(document.getElementById('feriasNomeColaborador').value)}&modelo=${document.getElementById('modeloFerias').value}&dataSaida=${document.getElementById('dataSaida').value}&dataRetorno=${document.getElementById('dataRetornoCalculada').value}&obs=${encodeURIComponent(document.getElementById('obsFerias').value)}`);
                alert('Solicita√ß√£o enviada!'); document.getElementById('formFerias').reset(); document.getElementById('boxPrevisao').style.display='none'; carregarHistoricoFerias();
            } catch(e) { alert('Erro.'); } finally { btn.disabled=false; btn.textContent='Agendar'; }
        }

        // ===== OUTROS (LOGIN, NAV, HORAS) =====
        async function handleLogin(e) {
            e.preventDefault(); const em=document.getElementById('email').value; const ps=document.getElementById('password').value;
            document.getElementById('loginBtn').disabled=true; document.getElementById('loadingSpinner').style.display='block';
            try { const res=await fetch(`${SCRIPT_URL}?action=validarCredenciais&email=${encodeURIComponent(em)}&senha=${encodeURIComponent(ps)}`); const data=await res.json();
                if(data.sucesso){ localStorage.setItem('userEmail',data.dados.email); localStorage.setItem('userName',data.dados.nome); document.getElementById('dashUserName').textContent=data.dados.nome.split(' ')[0]; document.getElementById('userEmail').textContent=data.dados.email; document.getElementById('loginScreen').style.display='none'; document.getElementById('dashboardScreen').classList.add('active'); init(); loadDashboardData(); resetInactivityTimer(); } 
                else { document.getElementById('errorMessage').textContent='Inv√°lido'; document.getElementById('errorMessage').style.display='block'; }
            } catch(e){alert('Conex√£o falhou');} finally{document.getElementById('loginBtn').disabled=false; document.getElementById('loadingSpinner').style.display='none';}
        }
        function handleLogout() { localStorage.clear(); location.reload(); }
        function showPage(id) {
            resetInactivityTimer(); document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id+'-page').classList.add('active'); document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            if(id=='dashboard') loadDashboardData(); if(id=='ferias') { carregarSelectFuncionarios(); carregarHistoricoFerias(); } if(id=='horas') { preencherPeriodos(); recarregarHorasExtras(); } if(id=='aprovacoes') verificarPermissaoAprovacao(); if(id=='funcionarios') carregarFuncionarios();
        }
        function resetInactivityTimer() { clearTimeout(inactivityTimer); inactivityTimer=setTimeout(handleLogout, INACTIVITY_TIMEOUT); }
        async function recarregarHorasExtras() {
            try { const val=document.getElementById('filtroPeriodo').value; let url=`${SCRIPT_URL}?action=obterDadosHorasExtras`; if(val){const [m,a]=val.split('-'); url+=`&mes=${m}&ano=${a}`;} const res=await fetch(url); const data=await res.json();
                if(data.sucesso) { document.getElementById('totalHorasExtras').textContent=data.dados.totalHoras; document.getElementById('periodoDisplay').textContent="Ciclo: "+data.dados.periodo; if(data.dados.colaboradorMaisHoras){document.getElementById('colaboradorMaisHoras').textContent=data.dados.colaboradorMaisHoras.horas; const el=document.getElementById('colaboradorChange'); if(el){el.textContent=data.dados.colaboradorMaisHoras.nome; el.style.display='block';}} renderChartHoras(data.dados.horasPorSetor);
                let html='<table><thead><tr><th style="width:50px">#</th><th>Nome</th><th>Horas</th></tr></thead><tbody>'; if(data.dados.ranking.length) data.dados.ranking.forEach((c,i)=>{let b=i<3?`<span class="rank-badge rank-${i+1}">${i+1}</span>`:i+1; html+=`<tr><td>${b}</td><td>${c.nome}</td><td style="font-weight:bold; color:#2c3e50;">${c.horas}</td></tr>`}); else html+='<tr><td colspan="3">Sem dados.</td></tr>'; document.getElementById('tabelaColaboradores').innerHTML=html+'</tbody></table>'; }
            } catch(e){}
        }
        function renderChartHoras(setores) { const ctx=document.getElementById('graficoHorasPorSetor'); if(!ctx)return; if(!setores||!setores.length){if(horasChartInstance)horasChartInstance.destroy();return;} const labels=setores.map(s=>s.setor); const vals=setores.map(s=>s.minutos); if(horasChartInstance)horasChartInstance.destroy(); horasChartInstance=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Minutos',data:vals,backgroundColor:'#3498db',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}}); }
        async function carregarSolicitacoesPendentes() {
            const div=document.getElementById('solicitacoesPendentes'); if(div.innerHTML.includes('Carregando')) div.innerHTML='<div class="loading-spinner" style="display:block"><div class="spinner"></div></div>';
            const res=await fetch(`${SCRIPT_URL}?action=obterSolicitacoesPendentes`); const data=await res.json();
            if(data.sucesso) { if(!data.dados.solicitacoes.length){div.innerHTML='<div style="text-align:center;padding:20px;color:#999;">Nada pendente.</div>';return;} let html='<table><thead><tr><th>Nome</th><th>Data</th><th>Horas</th><th>A√ß√µes</th></tr></thead><tbody>'; data.dados.solicitacoes.forEach(s=>{html+=`<tr><td>${s.nome}</td><td>${s.data.split('T')[0]}</td><td><strong>${s.horas}</strong></td><td><button onclick="acaoAprovar('${s.linha}',this)" class="btn-small btn-aprovar"><i class="fas fa-check"></i></button> <button onclick="acaoRejeitar('${s.linha}',this)" class="btn-small btn-rejeitar"><i class="fas fa-times"></i></button></td></tr>`;}); div.innerHTML=html+'</tbody></table>'; }
        }
        async function acaoAprovar(l,btn){if(!confirm('Aprovar?'))return; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>'; btn.disabled=true; await fetch(`${SCRIPT_URL}?action=aprovarSolicitacao&linha=${l}&emailAprovador=${localStorage.getItem('userEmail')}`); carregarSolicitacoesPendentes();}
        async function acaoRejeitar(l,btn){const m=prompt('Motivo:'); if(m){btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>'; btn.disabled=true; await fetch(`${SCRIPT_URL}?action=rejeitarSolicitacao&linha=${l}&emailAprovador=${localStorage.getItem('userEmail')}&motivo=${encodeURIComponent(m)}`); carregarSolicitacoesPendentes();}}
        async function carregarSelectFuncionarios(){const s=document.getElementById('feriasNomeColaborador'); s.innerHTML='<option>Carregando...</option>'; const res=await fetch(`${SCRIPT_URL}?action=obterFuncionarios`); const d=await res.json(); if(d.sucesso){s.innerHTML='<option value="">Selecione...</option>'; d.dados.funcionarios.forEach(f=>{let o=document.createElement('option'); o.value=f.nome; o.text=f.nome; s.appendChild(o);});}}
        function calcularVolta(){const s=document.getElementById('dataSaida').value; const m=document.getElementById('modeloFerias').value; if(!s||!m)return; let d=m=='30'?30:20; const dt=new Date(s+'T00:00:00'); const ret=new Date(dt); ret.setDate(dt.getDate()+d); document.getElementById('textoDataRetorno').textContent=ret.toLocaleDateString('pt-BR'); document.getElementById('dataRetornoCalculada').value=ret.toISOString().split('T')[0]; document.getElementById('boxPrevisao').style.display='block';}
        async function verificarPermissaoAprovacao(){const res=await fetch(`${SCRIPT_URL}?action=verificarPermissaoAprovacao&email=${encodeURIComponent(localStorage.getItem('userEmail'))}`); const d=await res.json(); if(d.sucesso&&d.dados.podeAprovar){document.getElementById('containerAprovacoes').style.display='block';document.getElementById('acessoNegado').style.display='none';carregarSolicitacoesPendentes();}else{document.getElementById('containerAprovacoes').style.display='none';document.getElementById('acessoNegado').style.display='block';}}
        async function carregarFuncionarios(){const d=document.getElementById('funcionariosContainer'); d.innerHTML='<div class="spinner"></div>'; const res=await fetch(`${SCRIPT_URL}?action=obterFuncionarios`); const dt=await res.json(); if(dt.sucesso){let h='<table><thead><tr><th>Nome</th><th>Cargo</th><th>A√ß√£o</th></tr></thead><tbody>'; dt.dados.funcionarios.forEach(f=>{h+=`<tr><td>${f.nome}</td><td>${f.cargo}</td><td><button onclick="delFunc('${f.linha}')" class="btn-small btn-rejeitar"><i class="fas fa-trash"></i></button></td></tr>`;}); d.innerHTML=h+'</tbody></table>';}}
        async function salvarFuncionario(){await fetch(`${SCRIPT_URL}?action=adicionarFuncionario&nome=${encodeURIComponent(document.getElementById('inputNome').value)}&cargo=${encodeURIComponent(document.getElementById('inputCargo').value)}&setor=${encodeURIComponent(document.getElementById('inputSetor').value)}&turno=${encodeURIComponent(document.getElementById('inputTurno').value)}`); document.getElementById('modalFuncionario').style.display='none'; carregarFuncionarios();}
        async function delFunc(l){if(confirm('Excluir?')) await fetch(`${SCRIPT_URL}?action=deletarFuncionario&linha=${l}`); carregarFuncionarios();}
        async function loadDashboardData() { document.getElementById('dataAtual').textContent=new Date().toLocaleDateString('pt-BR'); try{const rf=await fetch(`${SCRIPT_URL}?action=obterFuncionarios`); const df=await rf.json(); if(df.sucesso){document.getElementById('dashTotalFunc').textContent=df.dados.funcionarios.length; let sets={}; df.dados.funcionarios.forEach(f=>{let s=f.setor||'Geral';sets[s]=(sets[s]||0)+1;}); const ctx=document.getElementById('graficoDashboard'); if(dashboardChartInstance)dashboardChartInstance.destroy(); dashboardChartInstance=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(sets),datasets:[{data:Object.values(sets),backgroundColor:['#3498db','#e74c3c','#2ecc71','#f1c40f','#9b59b6'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{position:'right'}}}});} const rh=await fetch(`${SCRIPT_URL}?action=obterDadosHorasExtras`); const dh=await rh.json(); if(dh.sucesso)document.getElementById('dashHorasExtras').textContent=dh.dados.totalHoras; const rp=await fetch(`${SCRIPT_URL}?action=obterSolicitacoesPendentes`); const dp=await rp.json(); if(dp.sucesso)document.getElementById('dashPendencias').textContent=dp.dados.totalHoras; document.getElementById('dashFerias').textContent='--'; }catch(e){}}

        document.addEventListener('DOMContentLoaded', () => { document.addEventListener('mousemove', resetInactivityTimer); document.addEventListener('click', resetInactivityTimer); });
    </script>
</body>
</html>
