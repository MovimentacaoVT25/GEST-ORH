<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RH Manager - Sistema de Gest√£o de RH</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f5; color: #333; }

        /* ===== ESTILOS GERAIS E LAYOUT ===== */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); padding: 20px; }
        .login-box { background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); padding: 40px; width: 100%; max-width: 400px; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { font-size: 28px; color: #2c3e50; margin-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 14px; transition: all 0.3s ease; font-family: inherit; background-color: white; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        
        .login-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(44, 62, 80, 0.3); }
        .loading-spinner { display: none; text-align: center; padding: 20px; }
        .loading-spinner.show { display: block; }
        .spinner { border: 3px solid #ecf0f1; border-top: 3px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Dashboard */
        .dashboard-container { display: none; flex: 1; min-height: 100vh; }
        .dashboard-container.active { display: flex; }
        .sidebar { width: 210px; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-title { font-size: 18px; font-weight: 700; }
        .sidebar-user { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        .nav-menu { list-style: none; margin-top: 30px; }
        .nav-link { display: flex; align-items: center; gap: 10px; color: rgba(255,255,255,0.7); text-decoration: none; padding: 10px 12px; border-radius: 6px; font-size: 14px; cursor: pointer; border: none; background: none; width: 100%; text-align: left; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background-color: #3498db; color: white; }
        
        .main-content { margin-left: 210px; flex: 1; padding: 30px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 28px; font-weight: 700; color: #2c3e50; }
        
        /* Cards e Grids */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #3498db; }
        .kpi-value { font-size: 32px; font-weight: 700; color: #2c3e50; margin-top: 10px; }
        
        .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: #2c3e50; }
        
        .page { display: none; }
        .page.active { display: block; }

        /* Estilos Espec√≠ficos */
        .config-box { background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin-bottom: 20px; font-size: 13px; color: #856404; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        table th { background: #f5f5f5; padding: 12px; text-align: left; border-bottom: 2px solid #ecf0f1; }
        table td { padding: 12px; border-bottom: 1px solid #ecf0f1; }
        
        .btn-small { padding: 8px 12px; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-aprovar { background: #27ae60; color: white; }
        .btn-rejeitar { background: #e74c3c; color: white; }

        /* NOVO: Estilo Bot√£o Outline (Email) */
        .btn-outline { background: transparent; border: 2px solid #3498db; color: #3498db; font-weight: 600; transition: all 0.3s ease; }
        .btn-outline:hover { background: #ebf5fb; transform: translateY(-2px); }

        @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            .sidebar { width: 70px; padding: 15px; } 
            .sidebar-title, .sidebar-user { display: none; }
            .nav-link span:last-child { display: none; }
            .main-content { margin-left: 70px; padding: 20px; }
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>RH Manager</h1>
                <p>Sistema de Gest√£o de RH</p>
            </div>
            <div id="errorMessage" style="display:none; color:red; margin-bottom:10px; text-align:center;"></div>
            <div id="loadingSpinner" class="loading-spinner"><div class="spinner"></div><p>Validando...</p></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
                <div class="form-group"><label>Senha</label><input type="password" id="password" required></div>
                <button type="submit" class="login-btn" id="loginBtn">ENTRAR</button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-title">RH Manager</div>
            <div class="sidebar-user" id="userEmail">Usu√°rio</div>
            <div class="sidebar-user" id="userName" style="border:none; margin-top:0; padding-top:0;"></div>
            <nav>
                <ul class="nav-menu">
                    <li><button class="nav-link active" onclick="showPage('dashboard')"><i class="fas fa-chart-bar"></i> <span>Dashboard</span></button></li>
                    <li><button class="nav-link" onclick="showPage('horas')"><i class="fas fa-clock"></i> <span>Horas Extras</span></button></li>
                    <li><button class="nav-link" onclick="showPage('aprovacoes')"><i class="fas fa-check-circle"></i> <span>Aprova√ß√µes</span></button></li>
                    <li><button class="nav-link" onclick="showPage('ferias')"><i class="fas fa-umbrella-beach"></i> <span>F√©rias</span></button></li>
                    <li><button class="nav-link" onclick="showPage('funcionarios')"><i class="fas fa-users"></i> <span>Funcion√°rios</span></button></li>
                </ul>
            </nav>
            <button onclick="handleLogout()" class="nav-link" style="margin-top:20px; color:#e74c3c;"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></button>
        </aside>

        <main class="main-content">
            <div id="dashboard-page" class="page active">
                <div class="page-header"><h1 class="page-title">Dashboard</h1></div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-label">Funcion√°rios</div><div class="kpi-value" id="totalFuncionarios">--</div></div>
                    <div class="kpi-card" style="border-left-color: #27ae60;"><div class="kpi-label">Horas Extras (M√™s)</div><div class="kpi-value" id="horasExtras">--</div></div>
                </div>
            </div>

            <div id="horas-page" class="page">
                <div class="page-header">
                    <h1 class="page-title">Horas Extras</h1>
                    <button onclick="recarregarHorasExtras()" class="btn-small" style="background:#3498db; color:white; font-size:14px;">Atualizar</button>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-label">Total Horas</div><div class="kpi-value" id="totalHorasExtras">--</div></div>
                    <div class="kpi-card" style="border-left-color: #27ae60;"><div class="kpi-label">Maior Saldo</div><div class="kpi-value" id="colaboradorMaisHoras">--</div><small id="colaboradorChange"></small></div>
                </div>
                <div class="card"><h2 class="card-title">Por Setor</h2><div style="height:300px;"><canvas id="graficoHorasPorSetor"></canvas></div></div>
                <div class="card"><h2 class="card-title">Por Colaborador</h2><div id="tabelaColaboradores">Carregando...</div></div>
            </div>

            <div id="ferias-page" class="page">
                <div class="page-header"><h1 class="page-title">Agendamento de F√©rias</h1></div>
                
                <div class="content-grid">
                    <div class="card">
                        <h2 class="card-title">Nova Solicita√ß√£o</h2>
                        <form id="formFerias" onsubmit="event.preventDefault(); solicitarFerias();">
                            
                            <div class="form-group">
                                <label>Colaborador</label>
                                <select id="feriasNomeColaborador" required style="width: 100%; padding: 12px 15px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 14px; background-color: white;">
                                    <option value="">Carregando funcion√°rios...</option>
                                </select>
                                <input type="hidden" id="feriasEmailColaborador">
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label>Modelo de Gozo</label>
                                    <select id="modeloFerias" onchange="calcularVolta()" required>
                                        <option value="">Selecione...</option>
                                        <option value="30">30 dias corridos</option>
                                        <option value="20_10_venda">20 dias + Venda de 10</option>
                                        <option value="20_10_gozo">20 dias (1¬∫ per√≠odo)</option>
                                        <option value="15_9_7">15 dias (1¬∫ per√≠odo)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Data de In√≠cio</label>
                                    <input type="date" id="dataSaida" onchange="calcularVolta()" required>
                                </div>
                            </div>

                            <div class="config-box" id="boxPrevisao" style="display:none; margin-top: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div><strong>Retorno:</strong> <span id="textoDataRetorno" style="font-weight: bold;">--/--/----</span></div>
                                    <div style="text-align: right;"><small id="textoDiasGozo" style="color: #e67e22;"></small></div>
                                </div>
                                <input type="hidden" id="dataRetornoCalculada">
                            </div>

                            <div class="form-group">
                                <label>Observa√ß√µes</label>
                                <textarea id="obsFerias" rows="2" placeholder="Ex: Gostaria de adiantar a 1¬™ parcela do 13¬∫..."></textarea>
                            </div>

                            <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                                <button type="submit" id="btnSalvarFerias" style="width: 100%; background: #3498db; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                    Solicitar Agendamento (Sistema)
                                </button>
                                
                                <button type="button" onclick="abrirEmailRH()" class="btn-outline" style="width: 100%; padding: 12px; border-radius: 6px; cursor: pointer;">
                                    <i class="far fa-envelope"></i> Solicitar ao RH (E-mail)
                                </button>

                                <div id="loadingFerias" class="loading-spinner"><div class="spinner"></div></div>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <h2 class="card-title">Minhas Solicita√ß√µes</h2>
                        <div id="historicoFeriasContainer"><p style="text-align:center; color:#999;">Carregando...</p></div>
                        <div class="config-box" style="margin-top: 20px; background: #e8f4fd; border-color: #3498db; color: #2980b9;">
                            <strong>Regras:</strong>
                            <ul style="margin-top: 5px; margin-left: 20px; font-size: 12px;">
                                <li>F√©rias n√£o podem iniciar em sextas-feiras.</li>
                                <li>Solicitar com no m√≠nimo 30 dias de anteced√™ncia.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="aprovacoes-page" class="page">
                <div class="page-header"><h1 class="page-title">Aprova√ß√µes</h1></div>
                <div id="acessoNegado" style="display:none; text-align:center; padding:20px; background:white; border-radius:8px;">Acesso Negado</div>
                <div id="containerAprovacoes">
                    <div class="kpi-grid"><div class="kpi-card"><div class="kpi-label">Pendente</div><div class="kpi-value" id="totalHorasPendentes">00:00</div></div></div>
                    <div class="card"><h2 class="card-title">Pend√™ncias <button onclick="carregarSolicitacoesPendentes()" style="border:none; background:none; cursor:pointer;"><i class="fas fa-sync"></i></button></h2>
                    <div id="solicitacoesPendentes"><div class="loading-spinner" style="display:block"><div class="spinner"></div></div></div></div>
                </div>
            </div>

            <div id="funcionarios-page" class="page">
                <div class="page-header"><h1 class="page-title">Funcion√°rios</h1></div>
                <button onclick="abrirModalAdicionarFuncionario()" class="btn-small" style="background:#27ae60; color:white; margin-bottom:20px; font-size:14px;">+ Adicionar</button>
                <div class="card"><div id="funcionariosContainer"><div class="loading-spinner" style="display:block"><div class="spinner"></div></div></div></div>
            </div>

            <div id="modalFuncionario" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:white; padding:30px; border-radius:8px; width:90%; max-width:500px;">
                    <h2>Funcion√°rio</h2>
                    <form onsubmit="event.preventDefault(); salvarFuncionario();" style="margin-top:20px;">
                        <input type="hidden" id="linhaFuncionario">
                        <div class="form-group"><label>Nome</label><input id="inputNome" required></div>
                        <div class="form-group"><label>Cargo</label><input id="inputCargo"></div>
                        <div class="form-group"><label>Setor</label><input id="inputSetor"></div>
                        <div class="form-group"><label>Turno</label><input id="inputTurno"></div>
                        <div style="display:flex; gap:10px;">
                            <button type="submit" style="flex:1; background:#3498db; color:white; padding:10px; border:none; border-radius:6px;">Salvar</button>
                            <button type="button" onclick="document.getElementById('modalFuncionario').style.display='none'" style="flex:1; background:#95a5a6; color:white; padding:10px; border:none; border-radius:6px;">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // URL DO SEU BACKEND (Google Apps Script)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyFxQeuMozOpkKV4dwsY471jHgfFIL2NYUgzlp8O9N4b33N1SylVFSIDVlcBNVsvBB3/exec';
        
        const INACTIVITY_TIMEOUT = 300000; 
        let inactivityTimer;

        // ===== L√ìGICA DE F√âRIAS =====

        // 1. Carrega lista suspensa de funcion√°rios
        async function carregarSelectFuncionarios() {
            const select = document.getElementById('feriasNomeColaborador');
            const usuarioLogado = localStorage.getItem('userName');
            select.innerHTML = '<option value="">Carregando...</option>';

            try {
                const response = await fetch(`${SCRIPT_URL}?action=obterFuncionarios`);
                const data = await response.json();

                if (data.sucesso && data.dados.funcionarios) {
                    select.innerHTML = '<option value="">Selecione o Colaborador...</option>';
                    data.dados.funcionarios.forEach(func => {
                        const option = document.createElement('option');
                        option.value = func.nome; 
                        option.textContent = func.nome;
                        if (usuarioLogado && func.nome.toLowerCase() === usuarioLogado.toLowerCase()) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Erro ao carregar</option>';
                }
            } catch (error) {
                console.error(error);
                select.innerHTML = '<option value="">Erro de conex√£o</option>';
            }
        }

        function calcularVolta() {
            const dataSaidaInput = document.getElementById('dataSaida').value;
            const modelo = document.getElementById('modeloFerias').value;
            const boxPrevisao = document.getElementById('boxPrevisao');
            
            if (!dataSaidaInput || !modelo) { boxPrevisao.style.display = 'none'; return; }

            let diasDuracao = 0;
            let textoExtra = "";
            switch (modelo) {
                case '30': diasDuracao = 30; textoExtra = "30 dias"; break;
                case '20_10_venda': diasDuracao = 20; textoExtra = "20 dias + Abono"; break;
                case '20_10_gozo': diasDuracao = 20; textoExtra = "20 dias (Saldo: 10)"; break;
                case '15_9_7': diasDuracao = 15; textoExtra = "15 dias (Saldo: 16)"; break;
            }

            const dataObj = new Date(dataSaidaInput + 'T00:00:00');
            if (dataObj.getDay() === 5) alert("Aten√ß√£o: F√©rias n√£o devem iniciar na sexta-feira.");

            const dataRetornoObj = new Date(dataObj);
            dataRetornoObj.setDate(dataObj.getDate() + diasDuracao); 
            
            const dia = String(dataRetornoObj.getDate()).padStart(2, '0');
            const mes = String(dataRetornoObj.getMonth() + 1).padStart(2, '0');
            const ano = dataRetornoObj.getFullYear();

            document.getElementById('dataRetornoCalculada').value = dataRetornoObj.toISOString().split('T')[0];
            document.getElementById('textoDataRetorno').textContent = `${dia}/${mes}/${ano}`;
            document.getElementById('textoDiasGozo').textContent = textoExtra;
            boxPrevisao.style.display = 'block';
        }

        async function solicitarFerias() {
            resetInactivityTimer();
            const btn = document.getElementById('btnSalvarFerias');
            const loading = document.getElementById('loadingFerias');
            
            // Pega o nome do SELECT
            const nomeSelecionado = document.getElementById('feriasNomeColaborador').value;
            const modelo = document.getElementById('modeloFerias').value;
            const dataSaida = document.getElementById('dataSaida').value;
            const dataRetorno = document.getElementById('dataRetornoCalculada').value;
            const obs = document.getElementById('obsFerias').value;

            if (!nomeSelecionado || !modelo || !dataSaida) { alert("Preencha todos os campos."); return; }

            btn.style.display = 'none';
            loading.style.display = 'block';

            try {
                // Envia o nome no campo 'email' pois o backend espera um identificador na coluna B
                const url = `${SCRIPT_URL}?action=agendarFerias&email=${encodeURIComponent(nomeSelecionado)}&modelo=${modelo}&dataSaida=${dataSaida}&dataRetorno=${dataRetorno}&obs=${encodeURIComponent(obs)}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (data.sucesso) {
                    alert('‚úÖ ' + data.mensagem);
                    document.getElementById('formFerias').reset();
                    document.getElementById('boxPrevisao').style.display = 'none';
                    carregarHistoricoFerias();
                } else {
                    alert('‚ùå Erro: ' + data.mensagem);
                }
            } catch (error) {
                console.error(error);
                alert("Erro ao conectar.");
            } finally {
                btn.style.display = 'block';
                loading.style.display = 'none';
            }
        }

        // 2. Fun√ß√£o Bot√£o Email RH
        function abrirEmailRH() {
            const nome = document.getElementById('feriasNomeColaborador').value;
            const modelo = document.getElementById('modeloFerias').value;
            const dataInicio = document.getElementById('dataSaida').value;
            const dataRetorno = document.getElementById('dataRetornoCalculada').value;
            const obs = document.getElementById('obsFerias').value;

            if (!nome || !modelo || !dataInicio) { alert("Preencha o formul√°rio antes de gerar o e-mail."); return; }

            let modeloTexto = modelo;
            if (modelo === '30') modeloTexto = '30 dias corridos';
            else if (modelo === '20_10_venda') modeloTexto = '20 dias + Abono Pecuni√°rio';
            
            const dataInicioFormatada = dataInicio.split('-').reverse().join('/');
            const dataRetornoFormatada = dataRetorno ? dataRetorno.split('-').reverse().join('/') : 'A calcular';
            const emailRH = "rh@suaempresa.com"; // Defina o email do RH aqui se quiser fixo

            const assunto = encodeURIComponent(`Solicita√ß√£o de F√©rias - ${nome}`);
            const corpo = encodeURIComponent(`Ol√° RH,\n\nGostaria de solicitar o agendamento das minhas f√©rias:\n\nüë§ Colaborador: ${nome}\nüìÖ Modelo: ${modeloTexto}\nüöÄ In√≠cio: ${dataInicioFormatada}\nüîô Retorno: ${dataRetornoFormatada}\n\nüìù Obs:\n${obs}\n\nAtenciosamente,\n${nome}`);

            window.open(`mailto:${emailRH}?subject=${assunto}&body=${corpo}`);
        }

        async function carregarHistoricoFerias() {
            const usuarioLogado = localStorage.getItem('userName'); // Filtra pelo nome do usu√°rio logado se poss√≠vel
            const container = document.getElementById('historicoFeriasContainer');
            container.innerHTML = '<p style="text-align:center; color:#999;">Carregando...</p>';

            try {
                // Aqui estamos passando o Nome do usu√°rio logado para filtrar
                const url = `${SCRIPT_URL}?action=obterMinhasFerias&email=${encodeURIComponent(usuarioLogado)}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.sucesso && data.dados && data.dados.length > 0) {
                    let html = '<ul class="vacation-list" style="list-style:none;">';
                    data.dados.forEach(ferias => {
                        let corStatus = '#f39c12'; 
                        if(ferias.status === 'Aprovada') corStatus = '#27ae60';
                        if(ferias.status === 'Rejeitada') corStatus = '#c0392b';
                        const dataSaidaFormatada = ferias.saida.split('-').reverse().join('/');
                        
                        html += `<li style="border-bottom:1px solid #eee; padding:10px 0; display:flex; justify-content:space-between;">
                            <div><div style="font-weight:bold;">${ferias.modelo}</div><div style="font-size:12px; color:#777;">In√≠cio: ${dataSaidaFormatada}</div></div>
                            <div><span style="background:${corStatus}; color:white; padding:2px 8px; border-radius:10px; font-size:10px;">${ferias.status}</span></div>
                        </li>`;
                    });
                    html += '</ul>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Nenhuma solicita√ß√£o encontrada.</p>';
                }
            } catch (error) { container.innerHTML = '<p style="color:red; text-align:center;">Erro ao carregar hist√≥rico.</p>'; }
        }

        // ===== OUTRAS FUN√á√ïES DO SISTEMA (Login, Navega√ß√£o, etc) =====

        function showPage(pageName) {
            resetInactivityTimer();
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageName + '-page').classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            // Adicione a classe active no bot√£o clicado (simplificado aqui)

            if (pageName === 'aprovacoes') verificarPermissaoAprovacao();
            else if (pageName === 'funcionarios') carregarFuncionarios();
            else if (pageName === 'horas') carregarDadosHorasExtras();
            else if (pageName === 'ferias') {
                carregarSelectFuncionarios(); // Carrega o select
                carregarHistoricoFerias();    // Carrega a lista
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            document.getElementById('loginBtn').disabled = true;
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';

            try {
                const url = `${SCRIPT_URL}?action=validarCredenciais&email=${encodeURIComponent(email)}&senha=${encodeURIComponent(password)}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.sucesso) {
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userEmail', data.dados.email);
                    localStorage.setItem('userName', data.dados.nome);
                    
                    document.getElementById('userEmail').textContent = data.dados.email;
                    document.getElementById('userName').textContent = data.dados.nome;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboardScreen').style.display = 'flex';
                    
                    loadDashboardData();
                    resetInactivityTimer();
                } else {
                    document.getElementById('errorMessage').textContent = 'Email ou senha inv√°lidos';
                    document.getElementById('errorMessage').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('errorMessage').textContent = 'Erro de conex√£o';
                document.getElementById('errorMessage').style.display = 'block';
            } finally {
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        function handleLogout() {
            clearTimeout(inactivityTimer);
            localStorage.clear();
            location.reload();
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(handleLogout, INACTIVITY_TIMEOUT);
        }

        // Dashboard Data
        async function loadDashboardData() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=obterFuncionarios`);
                const data = await res.json();
                if(data.sucesso) document.getElementById('totalFuncionarios').textContent = data.dados.funcionarios.length;
            } catch(e) {}
        }
        
        // Horas Extras Data
        async function carregarDadosHorasExtras() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=obterDadosHorasExtras`);
                const data = await res.json();
                if(data.sucesso) {
                    document.getElementById('totalHorasExtras').textContent = data.dados.totalHoras;
                    if(data.dados.colaboradorMaisHoras) document.getElementById('colaboradorMaisHoras').textContent = data.dados.colaboradorMaisHoras.horas;
                    if(data.dados.horasPorSetor) atualizarGrafico(data.dados.horasPorSetor);
                }
                const resTab = await fetch(`${SCRIPT_URL}?action=obterHorasPorColaborador`);
                const dataTab = await resTab.json();
                renderizarTabelaHoras(dataTab.dados || []);
            } catch(e) {}
        }

        let chartInstance = null;
        function atualizarGrafico(setores) {
            const ctx = document.getElementById('graficoHorasPorSetor');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: setores.map(s => s.setor),
                    datasets: [{ label: 'Horas', data: setores.map(s => parseInt(s.horas.split(':')[0]) + parseInt(s.horas.split(':')[1])/60), backgroundColor: '#3498db' }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderizarTabelaHoras(colaboradores) {
            const container = document.getElementById('tabelaColaboradores');
            if(!colaboradores.length) { container.innerHTML = 'Sem dados'; return; }
            let html = '<div class="table-container"><table><thead><tr><th>Email</th><th>Horas</th></tr></thead><tbody>';
            colaboradores.forEach(c => html += `<tr><td>${c[0]}</td><td>${c[1]}</td></tr>`);
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Aprova√ß√µes
        async function verificarPermissaoAprovacao() {
            const email = localStorage.getItem('userEmail');
            const res = await fetch(`${SCRIPT_URL}?action=verificarPermissaoAprovacao&email=${encodeURIComponent(email)}`);
            const data = await res.json();
            if(data.sucesso && data.dados.podeAprovar) {
                document.getElementById('containerAprovacoes').style.display = 'block';
                document.getElementById('acessoNegado').style.display = 'none';
                carregarSolicitacoesPendentes();
            } else {
                document.getElementById('containerAprovacoes').style.display = 'none';
                document.getElementById('acessoNegado').style.display = 'block';
            }
        }

        async function carregarSolicitacoesPendentes() {
            const container = document.getElementById('solicitacoesPendentes');
            container.innerHTML = '<p>Carregando...</p>';
            const res = await fetch(`${SCRIPT_URL}?action=obterSolicitacoesPendentes`);
            const data = await res.json();
            if(data.sucesso) {
                document.getElementById('totalHorasPendentes').innerText = data.dados.totalHoras;
                if(!data.dados.solicitacoes.length) { container.innerHTML = 'Nenhuma pend√™ncia'; return; }
                let html = '<div class="table-container"><table><thead><tr><th>Nome</th><th>Data</th><th>Horas</th><th>A√ß√µes</th></tr></thead><tbody>';
                data.dados.solicitacoes.forEach(s => {
                    html += `<tr><td>${s.nome}</td><td>${s.data.split('T')[0]}</td><td>${s.horas}</td>
                    <td><button class="btn-small btn-aprovar" onclick="acaoAprovar('${s.linha}')">‚úì</button> <button class="btn-small btn-rejeitar" onclick="acaoRejeitar('${s.linha}')">‚úï</button></td></tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }
        }

        async function acaoAprovar(linha) {
            if(!confirm('Aprovar?')) return;
            const email = localStorage.getItem('userEmail');
            await fetch(`${SCRIPT_URL}?action=aprovarSolicitacao&linha=${linha}&emailAprovador=${encodeURIComponent(email)}`);
            carregarSolicitacoesPendentes();
        }

        async function acaoRejeitar(linha) {
            const motivo = prompt('Motivo:'); if(!motivo) return;
            const email = localStorage.getItem('userEmail');
            await fetch(`${SCRIPT_URL}?action=rejeitarSolicitacao&linha=${linha}&emailAprovador=${encodeURIComponent(email)}&motivo=${encodeURIComponent(motivo)}`);
            carregarSolicitacoesPendentes();
        }

        // Funcion√°rios CRUD
        async function carregarFuncionarios() {
            const container = document.getElementById('funcionariosContainer');
            const res = await fetch(`${SCRIPT_URL}?action=obterFuncionarios`);
            const data = await res.json();
            if(data.sucesso) {
                let html = '<div class="table-container"><table><thead><tr><th>Nome</th><th>Cargo</th><th>A√ß√µes</th></tr></thead><tbody>';
                data.dados.funcionarios.forEach(f => html += `<tr><td>${f.nome}</td><td>${f.cargo}</td><td><button class="btn-small btn-rejeitar" onclick="deletarFuncionario('${f.linha}')">Excluir</button></td></tr>`);
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }
        }

        function abrirModalAdicionarFuncionario() {
            document.getElementById('modalFuncionario').style.display = 'flex';
            document.getElementById('linhaFuncionario').value = '';
        }

        async function salvarFuncionario() {
            const nome = document.getElementById('inputNome').value;
            const cargo = document.getElementById('inputCargo').value;
            const setor = document.getElementById('inputSetor').value;
            const turno = document.getElementById('inputTurno').value;
            await fetch(`${SCRIPT_URL}?action=adicionarFuncionario&nome=${encodeURIComponent(nome)}&cargo=${encodeURIComponent(cargo)}&setor=${encodeURIComponent(setor)}&turno=${encodeURIComponent(turno)}`);
            document.getElementById('modalFuncionario').style.display = 'none';
            carregarFuncionarios();
        }

        async function deletarFuncionario(linha) {
            if(confirm('Excluir?')) {
                await fetch(`${SCRIPT_URL}?action=deletarFuncionario&linha=${linha}`);
                carregarFuncionarios();
            }
        }

        function recarregarHorasExtras() { carregarDadosHorasExtras(); }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dashboardScreen').style.display = 'none';
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
        });
    </script>
</body>
</html>
