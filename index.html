<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RH Manager - Sistema de Gest√£o</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f5; color: #333; }

        /* ===== LOGIN ===== */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); padding: 20px; }
        .login-box { background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); padding: 40px; width: 100%; max-width: 400px; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { font-size: 28px; color: #2c3e50; margin-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 14px; transition: 0.3s; background-color: white; }
        .login-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-small { padding: 8px 12px; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-aprovar { background: #27ae60; color: white; }
        .btn-rejeitar { background: #e74c3c; color: white; }
        .btn-outline { background: transparent; border: 2px solid #3498db; color: #3498db; font-weight: 600; transition: all 0.3s ease; }
        .loading-spinner { display: none; text-align: center; padding: 20px; }
        .spinner { border: 3px solid #ecf0f1; border-top: 3px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dashboard-container { display: none; flex: 1; min-height: 100vh; }
        .dashboard-container.active { display: flex; }
        .sidebar { width: 210px; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; z-index: 10; }
        .sidebar-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        .sidebar-user { font-size: 12px; color: rgba(255,255,255,0.5); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-bottom: 20px; }
        .nav-menu { list-style: none; }
        .nav-link { display: flex; align-items: center; gap: 10px; color: rgba(255,255,255,0.7); text-decoration: none; padding: 10px 12px; border-radius: 6px; font-size: 14px; cursor: pointer; border: none; background: none; width: 100%; text-align: left; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background-color: #3498db; color: white; }
        .main-content { margin-left: 210px; flex: 1; padding: 30px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 28px; font-weight: 700; color: #2c3e50; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid #3498db; position: relative; overflow: hidden; }
        .kpi-card.green { border-left-color: #27ae60; }
        .kpi-card.orange { border-left-color: #e67e22; }
        .kpi-card.purple { border-left-color: #9b59b6; }
        .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .kpi-label { font-size: 13px; color: #7f8c8d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 28px; font-weight: 700; color: #2c3e50; }
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .config-box { background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin-bottom: 20px; font-size: 13px; color: #856404; }
        .table-container { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        table th { background: #f8f9fa; padding: 12px; text-align: left; color: #2c3e50; font-weight: 600; border-bottom: 2px solid #e9ecef; }
        table td { padding: 12px; border-bottom: 1px solid #e9ecef; color: #555; }
        table tr:hover { background: #f1f1f1; }
        @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { width: 70px; padding: 15px; } .sidebar-title, .sidebar-user, .nav-link span { display: none; } .main-content { margin-left: 70px; padding: 15px; } }
        
        /* RANKING BADGES */
        .rank-badge { display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; font-size: 12px; font-weight: bold; color: white; background: #bdc3c7; }
        .rank-1 { background: #f1c40f; box-shadow: 0 2px 5px rgba(241, 196, 15, 0.4); }
        .rank-2 { background: #95a5a6; }
        .rank-3 { background: #d35400; }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header"><h1>RH Manager</h1><p>Sistema de Gest√£o Integrado</p></div>
            <div id="errorMessage" style="display:none; color:#e74c3c; margin-bottom:15px; text-align:center; font-size:14px; background:#fadbd8; padding:10px; border-radius:4px;"></div>
            <div id="loadingSpinner" class="loading-spinner"><div class="spinner"></div><p>Acessando...</p></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
                <div class="form-group"><label>Senha</label><input type="password" id="password" required></div>
                <button type="submit" class="login-btn" id="loginBtn">ACESSAR SISTEMA</button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-title">RH Manager</div>
            <div class="sidebar-user"><div style="font-weight:bold; color:white;" id="userName">Usu√°rio</div><div id="userEmail">email@empresa.com</div></div>
            <nav>
                <ul class="nav-menu">
                    <li><button class="nav-link active" onclick="showPage('dashboard')"><i class="fas fa-home"></i> <span>In√≠cio</span></button></li>
                    <li><button class="nav-link" onclick="showPage('horas')"><i class="fas fa-clock"></i> <span>Horas Extras</span></button></li>
                    <li><button class="nav-link" onclick="showPage('aprovacoes')"><i class="fas fa-check-double"></i> <span>Aprova√ß√µes</span></button></li>
                    <li><button class="nav-link" onclick="showPage('ferias')"><i class="fas fa-umbrella-beach"></i> <span>F√©rias</span></button></li>
                    <li><button class="nav-link" onclick="showPage('funcionarios')"><i class="fas fa-users"></i> <span>Funcion√°rios</span></button></li>
                </ul>
            </nav>
            <div style="margin-top:auto; padding-top:20px;"><button onclick="handleLogout()" class="nav-link" style="color:#e74c3c;"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></button></div>
        </aside>

        <main class="main-content">
            <div id="dashboard-page" class="page active">
                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
                    <div><h1 style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">Ol√°, <span id="dashUserName">Colaborador</span>! üëã</h1><p style="opacity: 0.9; font-size: 14px;">Aqui est√° o resumo da sua empresa hoje.</p></div>
                    <div style="text-align: right; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 8px;"><span style="font-size: 12px; display: block;">Hoje</span><strong id="dataAtual" style="font-size: 16px;">--/--/----</strong></div>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card blue"><div class="kpi-header"><span class="kpi-label">Funcion√°rios</span><div style="background: #ebf5fb; color: #3498db; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-users"></i></div></div><div class="kpi-value" id="dashTotalFunc">--</div><div class="kpi-change">Cadastrados</div></div>
                    <div class="kpi-card green"><div class="kpi-header"><span class="kpi-label">Horas Extras</span><div style="background: #e9f7ef; color: #27ae60; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-clock"></i></div></div><div class="kpi-value" id="dashHorasExtras">--</div><div class="kpi-change">Total no m√™s</div></div>
                    <div class="kpi-card orange"><div class="kpi-header"><span class="kpi-label">Pend√™ncias</span><div style="background: #fef5e7; color: #e67e22; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-exclamation-circle"></i></div></div><div class="kpi-value" id="dashPendencias">--</div><div class="kpi-change">Aguardando aprova√ß√£o</div></div>
                    <div class="kpi-card purple"><div class="kpi-header"><span class="kpi-label">F√©rias</span><div style="background: #f4ecf7; color: #9b59b6; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-plane"></i></div></div><div class="kpi-value" id="dashFerias">--</div><div class="kpi-change">Ativas/Programadas</div></div>
                </div>
                <div class="content-grid" style="grid-template-columns: 2fr 1fr;">
                    <div class="card"><h2 class="card-title">Distribui√ß√£o por Setor</h2><div style="height: 250px;"><canvas id="graficoDashboard"></canvas></div></div>
                    <div class="card"><h2 class="card-title">Acesso R√°pido</h2>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="showPage('ferias')" class="btn-outline" style="width:100%; text-align:left; padding:15px; border-radius:8px;">Solicitar F√©rias</button>
                            <button onclick="showPage('horas')" class="btn-outline" style="width:100%; text-align:left; padding:15px; border-radius:8px;">Banco de Horas</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="horas-page" class="page">
                <div class="page-header"><h1 class="page-title">Horas Extras (M√™s Atual)</h1><button onclick="recarregarHorasExtras()" class="btn-small" style="background:#3498db; color:white;">Atualizar Dados</button></div>
                <div class="kpi-grid">
                    <div class="kpi-card blue"><div class="kpi-label">Total Acumulado</div><div class="kpi-value" id="totalHorasExtras">--</div></div>
                    <div class="kpi-card green"><div class="kpi-label">Maior Saldo</div><div class="kpi-value" id="colaboradorMaisHoras">--</div><small id="colaboradorChange" style="display:none; font-weight:bold; color:#666; margin-top:5px;"></small></div>
                </div>
                <div class="content-grid">
                    <div class="card"><h2 class="card-title">Por Setor</h2><div style="height:250px;"><canvas id="graficoHorasPorSetor"></canvas></div></div>
                    <div class="card"><h2 class="card-title">Ranking de Colaboradores</h2><div id="tabelaColaboradores">Carregando...</div></div>
                </div>
            </div>

            <div id="aprovacoes-page" class="page">
                <div class="page-header"><h1 class="page-title">Central de Aprova√ß√µes</h1></div>
                <div id="acessoNegado" style="display:none; text-align:center; padding:40px;" class="card"><p>Acesso restrito a Gestores.</p></div>
                <div id="containerAprovacoes">
                    <div class="kpi-grid"><div class="kpi-card orange"><div class="kpi-label">Horas Pendentes</div><div class="kpi-value" id="totalHorasPendentes">00:00</div></div></div>
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h2 class="card-title" style="margin:0;">Solicita√ß√µes</h2><button onclick="carregarSolicitacoesPendentes()" style="border:none; background:none; cursor:pointer;"><i class="fas fa-sync"></i></button></div>
                        <div id="solicitacoesPendentes"><div class="loading-spinner" style="display:block"><div class="spinner"></div></div></div>
                    </div>
                </div>
            </div>

            <div id="ferias-page" class="page">
                <div class="page-header"><h1 class="page-title">Gest√£o de F√©rias</h1></div>
                <div class="content-grid">
                    <div class="card">
                        <h2 class="card-title">Nova Solicita√ß√£o</h2>
                        <form id="formFerias" onsubmit="event.preventDefault(); solicitarFerias();">
                            <div class="form-group"><label>Colaborador</label><select id="feriasNomeColaborador" required onchange="carregarHistoricoFerias()"><option value="">Carregando...</option></select></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group"><label>Modelo</label><select id="modeloFerias" onchange="calcularVolta()" required><option value="">Selecione...</option><option value="30">30 dias corridos</option><option value="20_10_venda">20 dias + Venda 10</option></select></div>
                                <div class="form-group"><label>In√≠cio</label><input type="date" id="dataSaida" onchange="calcularVolta()" required></div>
                            </div>
                            <div class="config-box" id="boxPrevisao" style="display:none;"><div style="display:flex; justify-content:space-between;"><span>Retorno: <strong id="textoDataRetorno">--/--/--</strong></span></div><input type="hidden" id="dataRetornoCalculada"></div>
                            <div class="form-group"><label>Obs</label><textarea id="obsFerias" rows="2"></textarea></div>
                            <button type="submit" id="btnSalvarFerias" class="login-btn">Agendar no Sistema</button>
                        </form>
                    </div>
                    <div class="card"><h2 class="card-title">Hist√≥rico</h2><div id="historicoFeriasContainer">Selecione um colaborador...</div></div>
                </div>
            </div>

            <div id="funcionarios-page" class="page">
                <div class="page-header"><h1 class="page-title">Funcion√°rios</h1></div>
                <button onclick="document.getElementById('modalFuncionario').style.display='flex'" class="btn-small btn-aprovar" style="padding:10px 20px; margin-bottom:20px;">+ Novo Cadastro</button>
                <div class="card"><div id="funcionariosContainer"><div class="loading-spinner" style="display:block"><div class="spinner"></div></div></div></div>
            </div>
            
            <div id="modalFuncionario" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:white; padding:30px; border-radius:8px; width:90%; max-width:400px;">
                    <h2 style="margin-bottom:20px;">Funcion√°rio</h2>
                    <form onsubmit="event.preventDefault(); salvarFuncionario();">
                        <div class="form-group"><label>Nome</label><input id="inputNome" required></div>
                        <div class="form-group"><label>Cargo</label><input id="inputCargo"></div>
                        <div class="form-group"><label>Setor</label><input id="inputSetor"></div>
                        <div class="form-group"><label>Turno</label><input id="inputTurno"></div>
                        <div style="display:flex; gap:10px; margin-top:20px;"><button type="submit" class="btn-small btn-aprovar" style="flex:1; padding:12px;">Salvar</button><button type="button" onclick="document.getElementById('modalFuncionario').style.display='none'" class="btn-small" style="flex:1; background:#95a5a6; color:white; padding:12px;">Cancelar</button></div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // CONFIGURA√á√ÉO
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwn3BpZAMo6-06MMsZKOj0pCAMWsCRAJ2ydNV8pxCckFgGaP6B5SFabLCjUflZuIYR6/exec';
        
        const INACTIVITY_TIMEOUT = 300000; 
        let inactivityTimer, dashboardChartInstance = null, horasChartInstance = null;

        // ===== L√ìGICA DO RANKING (ATUALIZADA) =====
        async function recarregarHorasExtras() {
            try {
                // AQUI EST√Å O SEGREDO: Chamamos APENAS obterDadosHorasExtras
                // Ele j√° traz o ranking sincronizado na propriedade 'ranking'
                const res = await fetch(`${SCRIPT_URL}?action=obterDadosHorasExtras`);
                const data = await res.json();
                
                if(data.sucesso) {
                    // Atualiza Totais e Maior Saldo
                    document.getElementById('totalHorasExtras').textContent = data.dados.totalHoras;
                    if(data.dados.colaboradorMaisHoras) {
                        document.getElementById('colaboradorMaisHoras').textContent = data.dados.colaboradorMaisHoras.horas;
                        const elNome = document.getElementById('colaboradorChange');
                        if(elNome) { elNome.textContent = data.dados.colaboradorMaisHoras.nome; elNome.style.display = 'block'; }
                    }
                    renderChartHoras(data.dados.horasPorSetor);

                    // Atualiza Tabela usando o array 'ranking' que veio junto
                    let html = '<div class="table-container"><table><thead><tr><th style="width:50px">#</th><th>Nome</th><th>Horas</th></tr></thead><tbody>';
                    
                    if(data.dados.ranking && data.dados.ranking.length > 0) {
                        data.dados.ranking.forEach((c, index) => {
                            let rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : 'rank-badge'));
                            let badge = index < 3 ? `<span class="rank-badge ${rankClass}">${index+1}</span>` : `<span style="color:#bdc3c7; font-weight:bold; margin-left:8px;">${index+1}</span>`;
                            
                            html += `<tr>
                                <td>${badge}</td>
                                <td>${c.nome}</td>
                                <td style="font-weight:bold; color:#2c3e50;">${c.horas}</td>
                            </tr>`;
                        });
                    } else {
                        html += '<tr><td colspan="3">Nenhum registro encontrado neste m√™s.</td></tr>';
                    }
                    document.getElementById('tabelaColaboradores').innerHTML = html + '</tbody></table></div>';
                }
            } catch(e) { console.error("Erro recarregarHorasExtras", e); }
        }

        // ===== OUTRAS FUN√á√ïES (MANTIDAS) =====
        async function loadDashboardData() {
            const nome = localStorage.getItem('userName') || 'Colaborador';
            document.getElementById('dashUserName').textContent = nome.split(' ')[0];
            document.getElementById('dataAtual').textContent = new Date().toLocaleDateString('pt-BR');
            try {
                const resFunc = await fetch(`${SCRIPT_URL}?action=obterFuncionarios`);
                const dataFunc = await resFunc.json();
                let setores = {};
                if(dataFunc.sucesso) {
                    document.getElementById('dashTotalFunc').textContent = dataFunc.dados.funcionarios.length;
                    dataFunc.dados.funcionarios.forEach(f => { setores[f.setor || 'Geral'] = (setores[f.setor || 'Geral'] || 0) + 1; });
                    renderizarGraficoDashboard(setores);
                }
                const resHoras = await fetch(`${SCRIPT_URL}?action=obterDadosHorasExtras`);
                const dataHoras = await resHoras.json();
                if(dataHoras.sucesso) document.getElementById('dashHorasExtras').textContent = dataHoras.dados.totalHoras;
                const resPend = await fetch(`${SCRIPT_URL}?action=obterSolicitacoesPendentes`);
                const dataPend = await resPend.json();
                if(dataPend.sucesso) document.getElementById('dashPendencias').textContent = dataPend.dados.solicitacoes.length;
                document.getElementById('dashFerias').textContent = '--'; 
            } catch(e) { console.error("Erro Dashboard", e); }
        }
        function renderizarGraficoDashboard(setoresData) {
            const ctx = document.getElementById('graficoDashboard'); if(!ctx) return;
            const labels = Object.keys(setoresData); const values = Object.values(setoresData);
            if(dashboardChartInstance) dashboardChartInstance.destroy();
            dashboardChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: labels.length?labels:['Vazio'], datasets: [{ data: values.length?values:[1], backgroundColor: ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#34495e'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right' } } } });
        }
        function renderChartHoras(setores) {
            const ctx = document.getElementById('graficoHorasPorSetor'); if(!ctx) return;
            if(!setores || setores.length === 0) { if(horasChartInstance) horasChartInstance.destroy(); return; }
            const labels = setores.map(s => s.setor); const dataMinutes = setores.map(s => s.minutos);
            if(horasChartInstance) horasChartInstance.destroy();
            horasChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Minutos', data: dataMinutes, backgroundColor: '#3498db', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(c) { let m=c.raw; return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(Math.round(m%60)).padStart(2,'0')} hs`; } } } }, scales: { y: { beginAtZero: true } } } });
        }
        async function carregarSelectFuncionarios() {
            const select = document.getElementById('feriasNomeColaborador'); select.innerHTML='<option>Carregando...</option>';
            const res = await fetch(`${SCRIPT_URL}?action=obterFuncionarios`); const data = await res.json();
            if(data.sucesso) { select.innerHTML='<option value="">Selecione...</option>'; data.dados.funcionarios.forEach(f=>{ let o=document.createElement('option'); o.value=f.nome; o.text=f.nome; if(localStorage.getItem('userName') && f.nome.includes(localStorage.getItem('userName').split(' ')[0])) o.selected=true; select.appendChild(o); }); carregarHistoricoFerias(); }
        }
        function calcularVolta() {
            const s = document.getElementById('dataSaida').value; const m = document.getElementById('modeloFerias').value;
            if(!s||!m) { document.getElementById('boxPrevisao').style.display='none'; return; }
            let d = m == '30' ? 30 : 20; const dt = new Date(s+'T00:00:00'); if(dt.getDay()==5) alert("Evite sexta-feira!");
            dt.setDate(dt.getDate() + d);
            document.getElementById('dataRetornoCalculada').value = dt.toISOString().split('T')[0];
            document.getElementById('textoDataRetorno').textContent = dt.toLocaleDateString('pt-BR');
            document.getElementById('boxPrevisao').style.display='block';
        }
        async function solicitarFerias() {
            const btn=document.getElementById('btnSalvarFerias'); const load=document.getElementById('loadingFerias');
            const n=document.getElementById('feriasNomeColaborador').value; const m=document.getElementById('modeloFerias').value;
            const s=document.getElementById('dataSaida').value; const r=document.getElementById('dataRetornoCalculada').value; const o=document.getElementById('obsFerias').value;
            if(!n||!s) { alert("Preencha tudo"); return; }
            btn.style.display='none'; load.style.display='block';
            try { await fetch(`${SCRIPT_URL}?action=agendarFerias&email=${encodeURIComponent(n)}&modelo=${m}&dataSaida=${s}&dataRetorno=${r}&obs=${encodeURIComponent(o)}`); alert('Agendado!'); document.getElementById('formFerias').reset(); document.getElementById('boxPrevisao').style.display='none'; carregarHistoricoFerias(); } catch(e){alert("Erro");} finally { btn.style.display='block'; load.style.display='none'; }
        }
        async function carregarHistoricoFerias() {
            const u=document.getElementById('feriasNomeColaborador').value || localStorage.getItem('userName');
            const div=document.getElementById('historicoFeriasContainer'); div.innerHTML='Carregando...';
            const res=await fetch(`${SCRIPT_URL}?action=obterMinhasFerias&email=${encodeURIComponent(u)}`); const d=await res.json();
            if(d.sucesso && d.dados.length) { let h=''; d.dados.forEach(f=>{ let dt=f.saida; if(dt.includes('-')) dt=dt.split('-').reverse().join('/'); h+=`<div style="border-bottom:1px solid #eee; padding:5px;"><strong>${f.modelo}</strong><br><small>In√≠cio: ${dt} - ${f.status}</small></div>`; }); div.innerHTML=h; } else div.innerHTML='Sem hist√≥rico.';
        }
        function abrirEmailRH() { window.open(`mailto:rh@empresa.com?subject=F√©rias&body=Solicito...`); }
        async function verificarPermissaoAprovacao() {
            const res = await fetch(`${SCRIPT_URL}?action=verificarPermissaoAprovacao&email=${encodeURIComponent(localStorage.getItem('userEmail'))}`);
            const data = await res.json();
            if(data.sucesso && data.dados.podeAprovar) { document.getElementById('containerAprovacoes').style.display='block'; document.getElementById('acessoNegado').style.display='none'; carregarSolicitacoesPendentes(); }
            else { document.getElementById('containerAprovacoes').style.display='none'; document.getElementById('acessoNegado').style.display='block'; }
        }
        async function carregarSolicitacoesPendentes() {
            const div=document.getElementById('solicitacoesPendentes'); div.innerHTML='Carregando...';
            const res=await fetch(`${SCRIPT_URL}?action=obterSolicitacoesPendentes`); const d=await res.json();
            if(d.sucesso) { document.getElementById('totalHorasPendentes').textContent=d.dados.totalHoras; let h='<div class="table-container"><table><thead><tr><th>Nome</th><th>Data</th><th>Horas</th><th>A√ß√µes</th></tr></thead><tbody>'; if(d.dados.solicitacoes.length) d.dados.solicitacoes.forEach(s=>{ h+=`<tr><td>${s.nome}</td><td>${s.data}</td><td>${s.horas}</td><td><button onclick="acaoAprovar('${s.linha}')" class="btn-small btn-aprovar">‚úì</button> <button onclick="acaoRejeitar('${s.linha}')" class="btn-small btn-rejeitar">‚úï</button></td></tr>`; }); else h+='<tr><td colspan="4">Nada pendente</td></tr>'; div.innerHTML=h+'</tbody></table></div>'; }
        }
        async function acaoAprovar(l) { if(confirm('Aprovar?')) await fetch(`${SCRIPT_URL}?action=aprovarSolicitacao&linha=${l}&emailAprovador=${localStorage.getItem('userEmail')}`); carregarSolicitacoesPendentes(); }
        async function acaoRejeitar(l) { const m=prompt('Motivo:'); if(m) await fetch(`${SCRIPT_URL}?action=rejeitarSolicitacao&linha=${l}&emailAprovador=${localStorage.getItem('userEmail')}&motivo=${encodeURIComponent(m)}`); carregarSolicitacoesPendentes(); }
        async function carregarFuncionarios() { const div=document.getElementById('funcionariosContainer'); div.innerHTML='Carregando...'; const res=await fetch(`${SCRIPT_URL}?action=obterFuncionarios`); const d=await res.json(); let h='<div class="table-container"><table><thead><tr><th>Nome</th><th>Cargo</th><th>A√ß√£o</th></tr></thead><tbody>'; d.dados.funcionarios.forEach(f=>{ h+=`<tr><td>${f.nome}</td><td>${f.cargo}</td><td><button onclick="delFunc('${f.linha}')" class="btn-small btn-rejeitar">Excluir</button></td></tr>`; }); div.innerHTML=h+'</tbody></table></div>'; }
        async function salvarFuncionario() { await fetch(`${SCRIPT_URL}?action=adicionarFuncionario&nome=${encodeURIComponent(document.getElementById('inputNome').value)}&cargo=${encodeURIComponent(document.getElementById('inputCargo').value)}&setor=${encodeURIComponent(document.getElementById('inputSetor').value)}&turno=${encodeURIComponent(document.getElementById('inputTurno').value)}`); document.getElementById('modalFuncionario').style.display='none'; carregarFuncionarios(); }
        async function delFunc(l) { if(confirm('Excluir?')) await fetch(`${SCRIPT_URL}?action=deletarFuncionario&linha=${l}`); carregarFuncionarios(); }
        async function handleLogin(e) { e.preventDefault(); document.getElementById('loginBtn').disabled=true; document.getElementById('loadingSpinner').style.display='block'; try{ const res=await fetch(`${SCRIPT_URL}?action=validarCredenciais&email=${encodeURIComponent(document.getElementById('email').value)}&senha=${encodeURIComponent(document.getElementById('password').value)}`); const d=await res.json(); if(d.sucesso){ localStorage.setItem('userEmail',d.dados.email); localStorage.setItem('userName',d.dados.nome); document.getElementById('userName').textContent=d.dados.nome; document.getElementById('userEmail').textContent=d.dados.email; document.getElementById('loginScreen').style.display='none'; document.getElementById('dashboardScreen').classList.add('active'); loadDashboardData(); resetInactivityTimer(); } else { document.getElementById('errorMessage').style.display='block'; } }catch(e){alert('Erro');} finally{document.getElementById('loginBtn').disabled=false; document.getElementById('loadingSpinner').style.display='none';} }
        function handleLogout() { clearTimeout(inactivityTimer); localStorage.clear(); location.reload(); }
        function showPage(id) { resetInactivityTimer(); document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id+'-page').classList.add('active'); document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active')); if(id=='dashboard')loadDashboardData(); if(id=='horas')recarregarHorasExtras(); if(id=='aprovacoes')verificarPermissaoAprovacao(); if(id=='ferias'){carregarSelectFuncionarios();} if(id=='funcionarios')carregarFuncionarios(); }
        function resetInactivityTimer() { clearTimeout(inactivityTimer); inactivityTimer=setTimeout(handleLogout,INACTIVITY_TIMEOUT); }
        document.addEventListener('DOMContentLoaded', () => { document.addEventListener('mousemove', resetInactivityTimer); document.addEventListener('click', resetInactivityTimer); });
    </script>
</body>
</html>




