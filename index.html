<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RH Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --warning: #f1c40f; --danger: #e74c3c; --bg: #f4f6f8; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: #333; }

        /* Login */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary), #34495e); }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); }
        .form-group input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 6px; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }

        /* Dashboard Layout */
        .dashboard-container { display: none; min-height: 100vh; }
        .dashboard-container.active { display: flex; }
        .sidebar { width: 240px; background: var(--primary); color: white; padding: 20px; position: fixed; height: 100vh; }
        .nav-link { display: block; width: 100%; padding: 12px; color: #bdc3c7; text-align: left; background: none; border: none; cursor: pointer; margin-bottom: 5px; border-radius: 6px; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: var(--accent); color: white; }
        .main-content { margin-left: 240px; flex: 1; padding: 30px; }

        /* Cards & Grids */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid var(--accent); }
        .kpi-card.green { border-left-color: var(--success); }
        .kpi-card.orange { border-left-color: var(--warning); }
        .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: #7f8c8d; font-size: 14px; font-weight: 600; text-transform: uppercase; }
        .kpi-value { font-size: 32px; font-weight: 700; color: var(--primary); }
        
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Tabelas */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: var(--primary); }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .btn-small { padding: 6px 12px; border-radius: 4px; border:none; cursor: pointer; color: white; font-size: 12px; }
        .btn-approve { background: var(--success); }
        .btn-reject { background: var(--danger); }
        
        /* Responsividade */
        @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { width: 70px; padding: 15px; } .nav-link span { display: none; } .main-content { margin-left: 70px; padding: 15px; } }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1 style="text-align:center; margin-bottom:20px; color:#2c3e50;">RH Manager</h1>
            <p id="msg" style="color:red; text-align:center; display:none;">Erro</p>
            <form onsubmit="login(event)">
                <div class="form-group"><label>Email</label><input id="email" type="email" required></div>
                <div class="form-group"><label>Senha</label><input id="pass" type="password" required></div>
                <button class="login-btn">Entrar</button>
            </form>
        </div>
    </div>

    <div id="app" class="dashboard-container">
        <aside class="sidebar">
            <h2 style="margin-bottom:30px; font-size:20px;">RH Manager</h2>
            <button class="nav-link active" onclick="go('dashboard')"><i class="fas fa-home"></i> <span>Início</span></button>
            <button class="nav-link" onclick="go('horas')"><i class="fas fa-clock"></i> <span>Horas Extras</span></button>
            <button class="nav-link" onclick="go('aprovacoes')"><i class="fas fa-check-double"></i> <span>Aprovações</span></button>
            <button class="nav-link" onclick="go('ferias')"><i class="fas fa-plane"></i> <span>Férias</span></button>
            <button class="nav-link" onclick="logout()" style="margin-top:50px; color:#e74c3c;"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></button>
        </aside>

        <main class="main-content">
            <div id="p-dashboard" class="page active">
                <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                    <h1 id="welcomeUser">Olá!</h1>
                    <p>Resumo do mês atual.</p>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-header">Funcionários</div><div class="kpi-value" id="kpiFunc">--</div></div>
                    <div class="kpi-card green"><div class="kpi-header">Horas Extras (Mês)</div><div class="kpi-value" id="kpiHoras">--</div></div>
                    <div class="kpi-card orange"><div class="kpi-header">Pendências</div><div class="kpi-value" id="kpiPend">--</div></div>
                </div>
                <div class="content-grid">
                    <div class="card"><h3>Distribuição</h3><div style="height:250px"><canvas id="chartDash"></canvas></div></div>
                    <div class="card"><h3>Acesso Rápido</h3><button onclick="go('ferias')" class="login-btn" style="margin-top:10px;">Solicitar Férias</button></div>
                </div>
            </div>

            <div id="p-horas" class="page" style="display:none;">
                <h1 style="margin-bottom:20px;">Horas Extras (Mês Atual)</h1>
                <div class="kpi-grid">
                    <div class="kpi-card green">
                        <div class="kpi-header">Total Mês</div>
                        <div class="kpi-value" id="totalMes">--</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">Maior Saldo</div>
                        <div class="kpi-value" id="topColabHoras">--</div>
                        <div id="topColabNome" style="color: #7f8c8d; font-weight: 600; margin-top: 5px;"></div>
                    </div>
                </div>
                <div class="content-grid">
                    <div class="card"><h3>Por Setor</h3><div style="height:250px"><canvas id="chartHoras"></canvas></div></div>
                    <div class="card">
                        <h3>Ranking</h3>
                        <div style="overflow-y:auto; max-height:300px;">
                            <table id="tableRanking"><tbody><tr><td>Carregando...</td></tr></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="p-aprovacoes" class="page" style="display:none;">
                <h1>Aprovações Pendentes</h1>
                <div id="listaPendencias" class="card" style="margin-top:20px;">Carregando...</div>
            </div>

            <div id="p-ferias" class="page" style="display:none;">
                <h1>Gestão de Férias</h1>
                <div class="card" style="margin-top:20px; max-width:600px;">
                    <div class="form-group"><label>Colaborador</label><select id="fNome"></select></div>
                    <div class="form-group"><label>Modelo</label><select id="fModelo"><option value="30">30 dias</option><option value="20_10_venda">20 dias + Abono</option></select></div>
                    <div class="form-group"><label>Início</label><input type="date" id="fInicio"></div>
                    <button onclick="salvarFerias()" class="login-btn">Agendar</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbzBhcMX0cs2UYA3AaeFwis-UKqTsnp7m_6nDEX4MBivD1ESfCLVdHkkCmYvTpCHfZ23/exec';
        
        async function login(e) {
            e.preventDefault();
            const em = document.getElementById('email').value;
            const ps = document.getElementById('pass').value;
            try {
                const r = await fetch(`${API}?action=validarCredenciais&email=${em}&senha=${ps}`);
                const d = await r.json();
                if(d.sucesso) {
                    localStorage.setItem('u', JSON.stringify(d.dados));
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('app').classList.add('active');
                    init();
                } else document.getElementById('msg').style.display='block';
            } catch(e) { alert('Erro conexão'); }
        }

        function go(id) {
            document.querySelectorAll('.page').forEach(p=>p.style.display='none');
            document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            document.getElementById('p-'+id).style.display='block';
            if(id=='horas') loadHoras();
            if(id=='aprovacoes') loadAprovacoes();
            if(id=='ferias') loadFerias();
        }

        async function init() {
            const u = JSON.parse(localStorage.getItem('u'));
            document.getElementById('welcomeUser').innerText = 'Olá, ' + u.nome.split(' ')[0] + '!';
            
            // Dados Dashboard
            const r1 = await fetch(`${API}?action=obterFuncionarios`);
            const d1 = await r1.json();
            document.getElementById('kpiFunc').innerText = d1.dados.funcionarios.length;

            const r2 = await fetch(`${API}?action=obterDadosHorasExtras`);
            const d2 = await r2.json();
            document.getElementById('kpiHoras').innerText = d2.dados.totalHoras;

            const r3 = await fetch(`${API}?action=obterSolicitacoesPendentes`);
            const d3 = await r3.json();
            document.getElementById('kpiPend').innerText = d3.dados.solicitacoes.length;
        }

        async function loadHoras() {
            const r = await fetch(`${API}?action=obterDadosHorasExtras`);
            const d = await r.json();
            
            document.getElementById('totalMes').innerText = d.dados.totalHoras;
            
            // Corrige exibição do nome do colaborador
            if(d.dados.colaboradorMaisHoras) {
                document.getElementById('topColabHoras').innerText = d.dados.colaboradorMaisHoras.horas;
                document.getElementById('topColabNome').innerText = d.dados.colaboradorMaisHoras.nome;
            }

            // Tabela Ranking
            const rTab = await fetch(`${API}?action=obterHorasPorColaborador`);
            const dTab = await rTab.json();
            let html = '<tbody>';
            dTab.dados.forEach(x => html += `<tr><td>${x[0]}</td><td><strong>${x[1]}</strong></td></tr>`);
            document.getElementById('tableRanking').innerHTML = html + '</tbody>';
        }

        async function loadAprovacoes() {
            const r = await fetch(`${API}?action=obterSolicitacoesPendentes`);
            const d = await r.json();
            let html = '<table><thead><tr><th>Nome</th><th>Data</th><th>Horas</th><th>Ação</th></tr></thead><tbody>';
            d.dados.solicitacoes.forEach(s => {
                html += `<tr><td>${s.nome}</td><td>${s.data}</td><td>${s.horas}</td>
                <td><button onclick="acao('${s.linha}', 'aprovar')" class="btn-small btn-approve">✓</button> 
                <button onclick="acao('${s.linha}', 'rejeitar')" class="btn-small btn-reject">✕</button></td></tr>`;
            });
            document.getElementById('listaPendencias').innerHTML = html + '</tbody></table>';
        }

        async function acao(l, tipo) {
            const ep = tipo == 'aprovar' ? 'aprovarSolicitacao' : 'rejeitarSolicitacao';
            const user = JSON.parse(localStorage.getItem('u')).email;
            await fetch(`${API}?action=${ep}&linha=${l}&emailAprovador=${user}`);
            loadAprovacoes();
        }

        async function loadFerias() {
            const r = await fetch(`${API}?action=obterFuncionarios`);
            const d = await r.json();
            const sel = document.getElementById('fNome');
            sel.innerHTML = '';
            d.dados.funcionarios.forEach(f => {
                let o = document.createElement('option');
                o.value = f.nome; o.text = f.nome;
                sel.add(o);
            });
        }

        async function salvarFerias() {
            const n = document.getElementById('fNome').value;
            const m = document.getElementById('fModelo').value;
            const i = document.getElementById('fInicio').value;
            await fetch(`${API}?action=agendarFerias&email=${n}&modelo=${m}&dataSaida=${i}`);
            alert('Agendado!');
        }

        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
