<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RH Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --warning: #f1c40f; --danger: #e74c3c; --bg: #f4f6f8; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: #333; }

        /* Login */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary), #34495e); }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); }
        .form-group input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 6px; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }

        /* Layout */
        .dashboard-container { display: none; min-height: 100vh; }
        .dashboard-container.active { display: flex; }
        .sidebar { width: 240px; background: var(--primary); color: white; padding: 20px; position: fixed; height: 100vh; z-index: 100; }
        .nav-link { display: block; width: 100%; padding: 12px; color: #bdc3c7; text-align: left; background: none; border: none; cursor: pointer; margin-bottom: 5px; border-radius: 6px; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: var(--accent); color: white; }
        .main-content { margin-left: 240px; flex: 1; padding: 30px; }

        /* Estrutura de Grades (Fix para não colapsar) */
        .kpi-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .content-grid { 
            display: grid; 
            grid-template-columns: 2fr 1fr; 
            gap: 20px; 
        }

        /* Cartões */
        .kpi-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid var(--accent); min-height: 120px; display: flex; flex-direction: column; justify-content: center; }
        .kpi-card.green { border-left-color: var(--success); }
        .kpi-card.orange { border-left-color: var(--warning); }
        
        .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: #7f8c8d; font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .kpi-value { font-size: 32px; font-weight: 700; color: var(--primary); }
        
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-title { margin-bottom: 20px; font-size: 18px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* Tabelas */
        .table-container { overflow-x: auto; width: 100%; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: var(--primary); }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .btn-small { padding: 6px 12px; border-radius: 4px; border:none; cursor: pointer; color: white; font-size: 12px; }
        .btn-approve { background: var(--success); }
        .btn-reject { background: var(--danger); }
        
        @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            .sidebar { width: 70px; padding: 15px; } 
            .nav-link span, .sidebar-title { display: none; } 
            .main-content { margin-left: 70px; padding: 15px; } 
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1 style="text-align:center; margin-bottom:20px; color:#2c3e50;">RH Manager</h1>
            <p id="msg" style="color:red; text-align:center; display:none;">Erro ao entrar</p>
            <form onsubmit="login(event)">
                <div class="form-group"><label>Email</label><input id="email" type="email" required></div>
                <div class="form-group"><label>Senha</label><input id="pass" type="password" required></div>
                <button class="login-btn">Entrar</button>
            </form>
        </div>
    </div>

    <div id="app" class="dashboard-container">
        <aside class="sidebar">
            <h2 class="sidebar-title" style="margin-bottom:30px; font-size:20px;">RH Manager</h2>
            <button class="nav-link active" onclick="go('dashboard')"><i class="fas fa-home"></i> <span>Início</span></button>
            <button class="nav-link" onclick="go('horas')"><i class="fas fa-clock"></i> <span>Horas Extras</span></button>
            <button class="nav-link" onclick="go('aprovacoes')"><i class="fas fa-check-double"></i> <span>Aprovações</span></button>
            <button class="nav-link" onclick="go('ferias')"><i class="fas fa-plane"></i> <span>Férias</span></button>
            <button class="nav-link" onclick="logout()" style="margin-top:50px; color:#e74c3c;"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></button>
        </aside>

        <main class="main-content">
            <div id="p-dashboard" class="page active">
                <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                    <h1 id="welcomeUser">Olá!</h1>
                    <p>Resumo do mês atual.</p>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-header">Funcionários</div><div class="kpi-value" id="kpiFunc">--</div></div>
                    <div class="kpi-card green"><div class="kpi-header">Horas Extras (Mês)</div><div class="kpi-value" id="kpiHoras">--</div></div>
                    <div class="kpi-card orange"><div class="kpi-header">Pendências</div><div class="kpi-value" id="kpiPend">--</div></div>
                </div>
                <div class="content-grid">
                    <div class="card"><h3 class="card-title">Distribuição</h3><div style="height:250px; width:100%;"><canvas id="chartDash"></canvas></div></div>
                    <div class="card"><h3 class="card-title">Acesso Rápido</h3><button onclick="go('ferias')" class="login-btn" style="margin-top:10px;">Solicitar Férias</button></div>
                </div>
            </div>

            <div id="p-horas" class="page" style="display:none;">
                <h1 style="margin-bottom:20px;">Horas Extras (Mês Atual)</h1>
                <div class="kpi-grid">
                    <div class="kpi-card green">
                        <div class="kpi-header">Total Mês</div>
                        <div class="kpi-value" id="totalMes">--</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">Maior Saldo</div>
                        <div class="kpi-value" id="topColabHoras">--</div>
                        <small id="topColabNome" style="color: #7f8c8d; font-weight: 600; display:block; margin-top: 5px;">Carregando...</small>
                    </div>
                </div>
                <div class="content-grid">
                    <div class="card"><h3 class="card-title">Por Setor</h3><div style="height:250px; width:100%;"><canvas id="chartHoras"></canvas></div></div>
                    <div class="card">
                        <h3 class="card-title">Ranking</h3>
                        <div class="table-container">
                            <table id="tableRanking"><thead><tr><th>Nome</th><th>Horas</th></tr></thead><tbody><tr><td>Carregando...</td></tr></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="p-aprovacoes" class="page" style="display:none;">
                <h1>Aprovações Pendentes</h1>
                <div class="card" style="margin-top:20px;">
                    <div class="table-container">
                        <table id="tableAprovacoes"><thead><tr><th>Nome</th><th>Data</th><th>Horas</th><th>Ações</th></tr></thead><tbody id="listaPendencias"><tr><td>Carregando...</td></tr></tbody></table>
                    </div>
                </div>
            </div>

            <div id="p-ferias" class="page" style="display:none;">
                <h1>Gestão de Férias</h1>
                <div class="content-grid">
                    <div class="card">
                        <h3 class="card-title">Nova Solicitação</h3>
                        <div class="form-group"><label>Colaborador</label><select id="fNome" style="width:100%"></select></div>
                        <div class="form-group"><label>Modelo</label><select id="fModelo" style="width:100%"><option value="30">30 dias</option><option value="20_10_venda">20 dias + Abono</option></select></div>
                        <div class="form-group"><label>Início</label><input type="date" id="fInicio" style="width:100%"></div>
                        <button onclick="salvarFerias()" class="login-btn">Agendar</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Histórico Recente</h3>
                        <div id="histFerias">Selecione um colaborador...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- COLE O LINK DO SEU SCRIPT AQUI ---
        const API = 'https://script.google.com/macros/s/AKfycbyU8ASR68MnwwixjGs0QV83ZkUpUI6N61Ika8-xW4_sGsrOv-Nn-H8j2JSwU8p8UQ0/exec';
        
        let chart1 = null, chart2 = null;

        async function login(e) {
            e.preventDefault();
            const em = document.getElementById('email').value;
            const ps = document.getElementById('pass').value;
            try {
                const r = await fetch(`${API}?action=validarCredenciais&email=${em}&senha=${ps}`);
                const d = await r.json();
                if(d.sucesso) {
                    localStorage.setItem('u', JSON.stringify(d.dados));
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('app').classList.add('active');
                    init();
                } else document.getElementById('msg').style.display='block';
            } catch(e) { alert('Erro conexão'); }
        }

        function go(id) {
            document.querySelectorAll('.page').forEach(p=>p.style.display='none');
            document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            document.getElementById('p-'+id).style.display='block';
            if(id=='horas') loadHoras();
            if(id=='aprovacoes') loadAprovacoes();
            if(id=='ferias') loadFerias();
        }

        async function init() {
            const u = JSON.parse(localStorage.getItem('u'));
            document.getElementById('welcomeUser').innerText = 'Olá, ' + u.nome.split(' ')[0] + '!';
            
            // Dados Dashboard
            const r1 = await fetch(`${API}?action=obterFuncionarios`);
            const d1 = await r1.json();
            document.getElementById('kpiFunc').innerText = d1.dados.funcionarios.length;

            const r2 = await fetch(`${API}?action=obterDadosHorasExtras`);
            const d2 = await r2.json();
            document.getElementById('kpiHoras').innerText = d2.dados.totalHoras;
            
            // Renderiza Gráfico Dashboard (com proteção se vazio)
            const ctx = document.getElementById('chartDash');
            if(chart1) chart1.destroy();
            const labels = d2.dados.horasPorSetor.map(x => x.setor);
            const vals = d2.dados.horasPorSetor.map(x => 1); // Simplificado para visual
            
            chart1 = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.length ? labels : ['Sem dados'],
                    datasets: [{ data: vals.length ? vals : [1], backgroundColor: ['#3498db', '#e74c3c', '#2ecc71'] }]
                },
                options: { maintainAspectRatio: false }
            });

            const r3 = await fetch(`${API}?action=obterSolicitacoesPendentes`);
            const d3 = await r3.json();
            document.getElementById('kpiPend').innerText = d3.dados.solicitacoes.length;
        }

        async function loadHoras() {
            const r = await fetch(`${API}?action=obterDadosHorasExtras`);
            const d = await r.json();
            
            document.getElementById('totalMes').innerText = d.dados.totalHoras;
            
            // Top Colaborador
            if(d.dados.colaboradorMaisHoras) {
                document.getElementById('topColabHoras').innerText = d.dados.colaboradorMaisHoras.horas;
                document.getElementById('topColabNome').innerText = d.dados.colaboradorMaisHoras.nome;
            }

            // Gráfico Barras
            const ctx = document.getElementById('chartHoras');
            if(chart2) chart2.destroy();
            const labels = d.dados.horasPorSetor.map(x=>x.setor);
            // Simples contagem para visualização
            chart2 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.length ? labels : ['Geral'],
                    datasets: [{ label: 'Horas', data: [10], backgroundColor: '#3498db' }]
                },
                options: { maintainAspectRatio: false }
            });

            // Ranking Tabela
            const rTab = await fetch(`${API}?action=obterHorasPorColaborador`);
            const dTab = await rTab.json();
            let html = '<thead><tr><th>Nome</th><th>Horas</th></tr></thead><tbody>';
            if(dTab.dados.length > 0) {
                dTab.dados.forEach(x => html += `<tr><td>${x[0]}</td><td><strong>${x[1]}</strong></td></tr>`);
            } else {
                html += '<tr><td colspan="2">Sem horas extras este mês.</td></tr>';
            }
            document.getElementById('tableRanking').innerHTML = html + '</tbody>';
        }

        async function loadAprovacoes() {
            const r = await fetch(`${API}?action=obterSolicitacoesPendentes`);
            const d = await r.json();
            const tbody = document.getElementById('listaPendencias');
            
            if(d.dados.solicitacoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Nenhuma pendência.</td></tr>';
                return;
            }

            let html = '';
            d.dados.solicitacoes.forEach(s => {
                html += `<tr><td>${s.nome}</td><td>${s.data}</td><td>${s.horas}</td>
                <td><button onclick="acao('${s.linha}', 'aprovar')" class="btn-small btn-approve">✓</button> 
                <button onclick="acao('${s.linha}', 'rejeitar')" class="btn-small btn-reject">✕</button></td></tr>`;
            });
            tbody.innerHTML = html;
        }

        async function acao(l, tipo) {
            const ep = tipo == 'aprovar' ? 'aprovarSolicitacao' : 'rejeitarSolicitacao';
            const user = JSON.parse(localStorage.getItem('u')).email;
            await fetch(`${API}?action=${ep}&linha=${l}&emailAprovador=${user}`);
            loadAprovacoes();
        }

        async function loadFerias() {
            const r = await fetch(`${API}?action=obterFuncionarios`);
            const d = await r.json();
            const sel = document.getElementById('fNome');
            sel.innerHTML = '';
            d.dados.funcionarios.forEach(f => {
                let o = document.createElement('option');
                o.value = f.nome; o.text = f.nome;
                sel.add(o);
            });
        }

        async function salvarFerias() {
            const n = document.getElementById('fNome').value;
            const m = document.getElementById('fModelo').value;
            const i = document.getElementById('fInicio').value;
            await fetch(`${API}?action=agendarFerias&email=${n}&modelo=${m}&dataSaida=${i}`);
            alert('Agendado!');
        }

        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
