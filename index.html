<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RH Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== ESTILO VISUAL PREMIUM (MANTIDO) ===== */
        :root {
            --primary: #2c3e50; --secondary: #34495e; --accent: #3498db;
            --success: #27ae60; --danger: #e74c3c; --warning: #f1c40f;
            --bg: #f4f7f6; --text: #333; --white: #fff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); overflow-x: hidden; }

        /* Animações e Estrutura */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page { display: none; width: 100%; } 
        .page.active { display: block; animation: fadeIn 0.4s ease-out forwards; }

        /* Layout Sidebar/Main */
        .dashboard-container { display: none; height: 100vh; overflow: hidden; }
        .dashboard-container.active { display: flex; }
        .sidebar { width: 240px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 25px; z-index: 10; flex-shrink: 0; }
        .main-content { flex: 1; background: var(--bg); overflow-y: auto; padding: 30px; position: relative; }

        /* Componentes */
        .card { background: white; border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 20px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--primary); font-weight: 600; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; }
        
        /* Botões */
        .btn-small { padding: 8px 14px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-aprovar { background: var(--success); color: white; }
        .btn-rejeitar { background: var(--danger); color: white; }
        .btn-outline { background: white; border: 1px solid #eee; color: var(--primary); width: 100%; padding: 12px; border-radius: 8px; cursor: pointer; text-align: left; }
        .btn-outline:hover { background: #f8f9fa; border-color: var(--accent); color: var(--accent); }
        
        /* Férias Específico */
        .ferias-row { cursor: pointer; transition: background 0.2s; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .ferias-row:hover { background-color: #f0f8ff; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; color: white; }
        .status-Pendente { background: #f1c40f; } .status-Aprovada { background: #27ae60; } .status-Rejeitada { background: #e74c3c; } .status-Solicitado { background: #3498db; }
        
        /* Modais */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: fadeIn 0.3s; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; cursor: pointer; color: #999; }

        /* Login */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary), var(--secondary)); position: fixed; width: 100%; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 400px; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* Outros estilos globais (KPIs, Header, etc) herdados do seu layout premium... */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 26px; font-weight: 700; color: var(--primary); }
        
        @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { width: 70px; padding: 15px; } .sidebar-user, .sidebar-title span { display: none; } }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2 style="text-align:center; color:var(--primary); margin-bottom:20px;">RH Manager</h2>
            <form onsubmit="handleLogin(event)">
                <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
                <div class="form-group"><label>Senha</label><input type="password" id="password" required></div>
                <button type="submit" class="login-btn" id="loginBtn">ACESSAR</button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" class="dashboard-container">
        <aside class="sidebar">
            <div style="font-size:20px; font-weight:bold; margin-bottom:30px; color:white;" class="sidebar-title">RH <span>Manager</span></div>
            <div class="sidebar-user" style="margin-bottom:20px; font-size:12px; opacity:0.8;">Olá, <span id="userName">Usuário</span></div>
            <nav style="display:flex; flex-direction:column; gap:5px;">
                <button class="btn-outline" onclick="showPage('dashboard')" style="border:none; background:transparent; color:white;"><i class="fas fa-home"></i> Início</button>
                <button class="btn-outline" onclick="showPage('horas')" style="border:none; background:transparent; color:white;"><i class="fas fa-clock"></i> Horas</button>
                <button class="btn-outline" onclick="showPage('aprovacoes')" style="border:none; background:transparent; color:white;"><i class="fas fa-check-circle"></i> Aprovações</button>
                <button class="btn-outline" onclick="showPage('ferias')" style="border:none; background:transparent; color:white;"><i class="fas fa-plane"></i> Férias</button>
                <button class="btn-outline" onclick="showPage('funcionarios')" style="border:none; background:transparent; color:white;"><i class="fas fa-users"></i> Funcionários</button>
            </nav>
        </aside>

        <main class="main-content">
            
            <div id="dashboard-page" class="page active">
                <div class="page-header"><h1 class="page-title">Dashboard</h1></div>
                <div class="card"><p>Bem-vindo ao sistema de gestão.</p></div>
            </div>

            <div id="ferias-page" class="page">
                <div class="page-header">
                    <h1 class="page-title">Gestão de Férias</h1>
                    <button onclick="abrirConfigEmails()" class="btn-small" style="background:#34495e; color:white;"><i class="fas fa-cog"></i> Configurações</button>
                </div>
                
                <div class="content-grid">
                    <div class="card">
                        <h2 class="card-title">Nova Solicitação</h2>
                        <form id="formFerias" onsubmit="event.preventDefault(); solicitarFerias();">
                            <div class="form-group"><label>Colaborador</label><select id="feriasNomeColaborador" required><option>Carregando...</option></select></div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                                <div class="form-group"><label>Modelo</label><select id="modeloFerias" onchange="calcularVolta()" required><option value="30">30 dias</option><option value="20_10_venda">20 + Venda</option></select></div>
                                <div class="form-group"><label>Início</label><input type="date" id="dataSaida" onchange="calcularVolta()" required></div>
                            </div>
                            <div id="boxPrevisao" style="background:#fef9e7; padding:10px; border-radius:6px; margin-bottom:15px; display:none;">
                                <strong>Retorno: <span id="textoDataRetorno">--/--/--</span></strong><input type="hidden" id="dataRetornoCalculada">
                            </div>
                            <div class="form-group"><label>Obs</label><textarea id="obsFerias" rows="2"></textarea></div>
                            
                            <div style="display:flex; justify-content:center; margin-top:20px;">
                                <button type="submit" id="btnSalvarFerias" class="btn-aprovar" style="padding:12px 40px; border-radius:25px; font-size:14px; font-weight:bold; cursor:pointer; border:none; box-shadow:0 4px 10px rgba(39, 174, 96, 0.3);">AGENDAR FÉRIAS</button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <h2 class="card-title">Solicitações (Todos)</h2>
                        <div id="historicoFeriasContainer">Carregando...</div>
                    </div>
                </div>
            </div>

            <div id="modalDetalhesFerias" class="modal-overlay">
                <div class="modal-box">
                    <i class="fas fa-times modal-close" onclick="document.getElementById('modalDetalhesFerias').style.display='none'"></i>
                    <h2 style="margin-bottom:15px; color:var(--primary);">Detalhes da Solicitação</h2>
                    
                    <div id="conteudoDetalhesFerias" style="margin-bottom:25px; line-height:1.6; font-size:14px; color:#555;"></div>
                    <input type="hidden" id="linhaFeriasAtual">
                    <input type="hidden" id="dadosFeriasAtual"> <button onclick="agendarViaEmailManual()" class="btn-outline" style="width:100%; justify-content:center; margin-bottom:15px; border-color:#3498db; color:#3498db;">
                        <i class="far fa-envelope"></i> Agendar via E-mail
                    </button>

                    <div style="display:flex; gap:10px;">
                        <button onclick="acaoFerias('Aprovada')" class="btn-small btn-aprovar" style="flex:1; padding:12px;">Aprovar</button>
                        <button onclick="acaoFerias('Rejeitada')" class="btn-small btn-rejeitar" style="flex:1; padding:12px;">Rejeitar</button>
                    </div>
                </div>
            </div>

            <div id="modalConfigEmails" class="modal-overlay">
                <div class="modal-box">
                    <h2 style="margin-bottom:10px;">Configurar Notificações</h2>
                    <p style="font-size:12px; color:#666; margin-bottom:15px;">Insira os e-mails que receberão o aviso automático de agendamento (separados por vírgula).</p>
                    <textarea id="inputEmailsConfig" rows="4" style="width:100%; border:1px solid #ddd; padding:10px; border-radius:6px; margin-bottom:15px;" placeholder="gestor@empresa.com, rh@empresa.com"></textarea>
                    <button onclick="salvarConfigEmails()" class="btn-small btn-aprovar" style="width:100%; padding:10px;">Salvar Configuração</button>
                    <button onclick="document.getElementById('modalConfigEmails').style.display='none'" class="btn-small" style="background:#95a5a6; color:white; width:100%; margin-top:5px; padding:10px;">Fechar</button>
                </div>
            </div>

            <div id="horas-page" class="page"><h1>Horas</h1></div>
            <div id="aprovacoes-page" class="page"><h1>Aprovações</h1></div>
            <div id="funcionarios-page" class="page"><h1>Funcionários</h1></div>

        </main>
    </div>

    <script>
        // ATUALIZE AQUI COM SEU LINK DE IMPLANTAÇÃO
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzTXsHfIAlkqIcMLoUY3ojgVl1wgq2WrY0onh0iH7qnm272HkI-5tknfjtaQ_MTE7Q/exec';
        
        const INACTIVITY_TIMEOUT = 300000; 
        let inactivityTimer;

        // FÉRIAS - FUNÇÕES PRINCIPAIS
        async function carregarHistoricoFerias() {
            const div = document.getElementById('historicoFeriasContainer');
            div.innerHTML = 'Carregando...';
            try {
                const res = await fetch(`${SCRIPT_URL}?action=obterTodasFerias`);
                const data = await res.json();
                if(data.sucesso && data.dados.length) {
                    let html = '<div style="max-height:300px; overflow-y:auto;">';
                    data.dados.forEach(f => {
                        html += `<div class="ferias-row" onclick='abrirDetalhesFerias(${JSON.stringify(f)})'>
                            <div><strong>${f.colaborador}</strong><br><span style="font-size:11px; color:#777;">${f.saida.split('-').reverse().join('/')}</span></div>
                            <span class="status-badge status-${f.status}">${f.status}</span>
                        </div>`;
                    });
                    div.innerHTML = html + '</div>';
                } else div.innerHTML = 'Nada encontrado.';
            } catch(e) { div.innerHTML = 'Erro.'; }
        }

        function abrirDetalhesFerias(f) {
            document.getElementById('linhaFeriasAtual').value = f.linha;
            // Guardamos os dados no input hidden para usar no botão de email manual
            document.getElementById('dadosFeriasAtual').value = JSON.stringify(f);
            
            document.getElementById('conteudoDetalhesFerias').innerHTML = `
                <p><strong>Colaborador:</strong> ${f.colaborador}</p>
                <p><strong>Modelo:</strong> ${f.modelo}</p>
                <p><strong>Início:</strong> ${f.saida.split('-').reverse().join('/')}</p>
                <p><strong>Retorno:</strong> ${f.retorno.split('-').reverse().join('/')}</p>
                <p><strong>Obs:</strong> ${f.obs || '-'}</p>
                <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                <p><strong>Status Atual:</strong> ${f.status}</p>
            `;
            document.getElementById('modalDetalhesFerias').style.display = 'flex';
        }

        // AÇÃO DO NOVO BOTÃO "AGENDAR VIA E-MAIL" (MANUAL)
        function agendarViaEmailManual() {
            const dadosStr = document.getElementById('dadosFeriasAtual').value;
            if(!dadosStr) return;
            const f = JSON.parse(dadosStr);
            
            const assunto = `Agendamento de Férias - ${f.colaborador}`;
            const corpo = `Olá,\n\nSegue confirmação de agendamento de férias.\n\nColaborador: ${f.colaborador}\nInício: ${f.saida}\nRetorno: ${f.retorno}\nModelo: ${f.modelo}\n\nAtenciosamente,\nRH.`;
            
            window.open(`mailto:?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`);
        }

        // CONFIGURAÇÃO DE EMAILS AUTOMÁTICOS
        async function abrirConfigEmails() {
            const res = await fetch(`${SCRIPT_URL}?action=obterEmailsNotificacao`);
            const data = await res.json();
            document.getElementById('inputEmailsConfig').value = data.dados.emails;
            document.getElementById('modalConfigEmails').style.display = 'flex';
        }

        async function salvarConfigEmails() {
            const emails = document.getElementById('inputEmailsConfig').value;
            await fetch(`${SCRIPT_URL}?action=salvarEmailsNotificacao&emails=${encodeURIComponent(emails)}`);
            document.getElementById('modalConfigEmails').style.display = 'none';
            alert('Configuração salva! Os próximos agendamentos enviarão e-mail para esta lista.');
        }

        async function solicitarFerias() {
            const btn = document.getElementById('btnSalvarFerias');
            btn.disabled = true; btn.textContent = 'Enviando...';
            try {
                // Ao chamar agendarFerias, o Backend já envia o e-mail automático para a lista configurada
                await fetch(`${SCRIPT_URL}?action=agendarFerias&email=${encodeURIComponent(document.getElementById('feriasNomeColaborador').value)}&modelo=${document.getElementById('modeloFerias').value}&dataSaida=${document.getElementById('dataSaida').value}&dataRetorno=${document.getElementById('dataRetornoCalculada').value}&obs=${encodeURIComponent(document.getElementById('obsFerias').value)}`);
                alert('Solicitação enviada e e-mails notificados!');
                document.getElementById('formFerias').reset();
                document.getElementById('boxPrevisao').style.display='none';
                carregarHistoricoFerias();
            } catch(e) { alert('Erro.'); }
            finally { btn.disabled = false; btn.textContent = 'AGENDAR FÉRIAS'; }
        }

        // ACÕES APROVAR/REJEITAR
        async function acaoFerias(status) {
            const linha = document.getElementById('linhaFeriasAtual').value;
            if(!confirm(`Confirmar ${status}?`)) return;
            document.getElementById('modalDetalhesFerias').style.display = 'none';
            await fetch(`${SCRIPT_URL}?action=alterarStatusFerias&linha=${linha}&status=${status}&emailUser=RH`);
            carregarHistoricoFerias();
        }

        // AUXILIARES
        async function carregarSelectFuncionarios(){const s=document.getElementById('feriasNomeColaborador'); s.innerHTML='<option>Carregando...</option>'; const res=await fetch(`${SCRIPT_URL}?action=obterFuncionarios`); const d=await res.json(); if(d.sucesso){s.innerHTML='<option value="">Selecione...</option>'; d.dados.funcionarios.forEach(f=>{let o=document.createElement('option'); o.value=f.nome; o.text=f.nome; s.appendChild(o);});}}
        function calcularVolta(){const s=document.getElementById('dataSaida').value; const m=document.getElementById('modeloFerias').value; if(!s||!m)return; let d=m=='30'?30:20; const dt=new Date(s+'T00:00:00'); const ret=new Date(dt); ret.setDate(dt.getDate()+d); document.getElementById('textoDataRetorno').textContent=ret.toLocaleDateString('pt-BR'); document.getElementById('dataRetornoCalculada').value=ret.toISOString().split('T')[0]; document.getElementById('boxPrevisao').style.display='block';}

        // LOGIN E NAV
        async function handleLogin(e) { e.preventDefault(); document.getElementById('loginScreen').style.display='none'; document.getElementById('dashboardScreen').classList.add('active'); showPage('ferias'); } // Forçando ir para ferias para teste
        function showPage(id) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id+'-page').classList.add('active'); if(id=='ferias'){carregarSelectFuncionarios(); carregarHistoricoFerias();} }
        function handleLogout() { location.reload(); }
        
        document.addEventListener('DOMContentLoaded', () => { 
            // Inicia listeners se necessário
        });
    </script>
</body>
</html>
