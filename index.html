<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RH Manager - Sistema de Gest√£o</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --bg-light: #f4f7f6;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #95a5a6;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-dark); -webkit-font-smoothing: antialiased; }

        /* ===== ANIMA√á√ïES ===== */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* ===== LOGIN ===== */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); padding: 20px; }
        .login-box { background: var(--white); padding: 40px; border-radius: var(--radius); width: 100%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: fadeIn 0.6s ease; }
        .login-header h1 { font-size: 26px; color: var(--primary); margin-bottom: 5px; text-align: center; }
        .login-header p { text-align: center; color: var(--text-light); margin-bottom: 30px; font-size: 14px; }
        
        /* ===== FORMUL√ÅRIOS ===== */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-dark); font-weight: 600; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; transition: 0.3s; background: #fff; color: var(--text-dark); font-family: inherit; }
        .form-group input:focus, .form-group select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        
        /* ===== BOT√ïES ===== */
        .btn-base { border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .login-btn { width: 100%; padding: 14px; background: var(--primary); color: white; margin-top: 10px; font-size: 15px; }
        .login-btn:hover { background: var(--secondary); transform: translateY(-2px); }
        
        .btn-small { padding: 8px 16px; font-size: 12px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #219150; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-excel { background: #217346; color: white; } /* Cor Excel */
        .btn-excel:hover { background: #1e6b40; }

        .btn-outline { background: transparent; border: 2px solid #ecf0f1; color: var(--text-dark); padding: 15px; width: 100%; justify-content: flex-start; }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); background: #ebf5fb; }
        .btn-icon-wrapper { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 14px; }

        /* ===== LAYOUT ===== */
        .dashboard-container { display: none; height: 100vh; overflow: hidden; }
        .dashboard-container.active { display: flex; }
        
        .sidebar { width: 250px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 25px; transition: 0.3s; z-index: 100; box-shadow: 4px 0 20px rgba(0,0,0,0.1); }
        .sidebar-header { margin-bottom: 40px; }
        .sidebar-brand { font-size: 20px; font-weight: 700; display: block; margin-bottom: 5px; }
        .sidebar-user { font-size: 12px; color: rgba(255,255,255,0.6); }
        
        .nav-link { display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.7); text-decoration: none; padding: 12px 15px; border-radius: 8px; font-size: 14px; transition: 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; transform: translateX(5px); }
        .nav-link i { width: 20px; text-align: center; }

        .main-content { flex: 1; background: var(--bg-light); overflow-y: auto; padding: 30px; position: relative; }
        
        .page { display: none; opacity: 0; }
        .page.active { display: block; animation: fadeIn 0.4s ease-out forwards; }

        .header-page { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: 700; color: var(--text-dark); }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .select-periodo { padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* ===== CARDS & KPI ===== */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; min-height: 140px; transition: transform 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        
        .kpi-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
        .kpi-card.blue::before { background: var(--accent); }
        .kpi-card.green::before { background: var(--success); }
        .kpi-card.orange::before { background: var(--warning); }
        .kpi-card.purple::before { background: #9b59b6; }

        .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .kpi-label { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--text-light); letter-spacing: 0.5px; }
        .kpi-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .kpi-value { font-size: 32px; font-weight: 700; color: var(--text-dark); }
        .kpi-sub { font-size: 12px; color: var(--text-light); margin-top: 5px; }

        /* ===== CONTENT GRID ===== */
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .card { background: white; border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); height: 100%; transition: all 0.3s; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .card-title { font-size: 16px; font-weight: 700; color: var(--text-dark); }

        /* ===== TABLE ===== */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 15px; color: var(--text-light); font-weight: 600; border-bottom: 2px solid #f0f0f0; background: #fafafa; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; color: var(--text-dark); vertical-align: middle; }
        tr:hover td { background: #f9f9f9; }
        
        .rank-badge { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; color: white; background: #bdc3c7; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .rank-1 { background: #f1c40f; transform: scale(1.1); }
        .rank-2 { background: #95a5a6; }
        .rank-3 { background: #d35400; }

        /* LOADING */
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* LINHA PROCESSANDO */
        .row-processing { opacity: 0.5; pointer-events: none; transition: opacity 0.3s; }

        /* RESPONSIVO */
        @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            .sidebar { width: 80px; padding: 15px; align-items: center; } 
            .sidebar-brand, .sidebar-user, .nav-link span { display: none; }
            .nav-link { justify-content: center; padding: 15px; }
            .nav-link i { font-size: 20px; width: auto; }
            .main-content { margin-left: 80px; padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="globalLoading" class="loading-overlay"><div class="spinner"></div></div>

    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>RH Manager</h1>
                <p>Sistema de Gest√£o Integrado</p>
            </div>
            <div id="errorMessage" style="display:none; color:var(--danger); background:#fdecea; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center; font-size:13px;"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group"><label>Email Corporativo</label><input type="email" id="email" required></div>
                <div class="form-group"><label>Senha</label><input type="password" id="password" required></div>
                <button type="submit" class="btn-base login-btn" id="loginBtn">ACESSAR SISTEMA</button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-brand">RH Manager</span>
                <span class="sidebar-user" id="userName">Usu√°rio</span>
                <span class="sidebar-user" id="userEmail" style="font-size:10px; opacity:0.7;">email@...</span>
            </div>
            <nav style="flex:1;">
                <button class="nav-link active" onclick="showPage('dashboard')"><i class="fas fa-home"></i> <span>In√≠cio</span></button>
                <button class="nav-link" onclick="showPage('horas')"><i class="fas fa-clock"></i> <span>Horas Extras</span></button>
                <button class="nav-link" onclick="showPage('aprovacoes')"><i class="fas fa-check-circle"></i> <span>Aprova√ß√µes</span></button>
                <button class="nav-link" onclick="showPage('ferias')"><i class="fas fa-plane"></i> <span>F√©rias</span></button>
                <button class="nav-link" onclick="showPage('funcionarios')"><i class="fas fa-users"></i> <span>Funcion√°rios</span></button>
            </nav>
            <button onclick="handleLogout()" class="nav-link" style="color:var(--danger); margin-top: auto;"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></button>
        </aside>

        <main class="main-content">
            
            <div id="dashboard-page" class="page active">
                <div class="header-page">
                    <div>
                        <h1 class="page-title">Ol√°, <span id="dashUserName">Colaborador</span>! üëã</h1>
                        <p style="color:var(--text-light); font-size:14px;">Vis√£o geral do sistema.</p>
                    </div>
                    <div style="text-align:right;">
                        <div style="background:white; padding:10px 20px; border-radius:8px; box-shadow:var(--shadow); font-weight:600; color:var(--primary);">
                            <i class="far fa-calendar-alt"></i> <span id="dataAtual">--/--/--</span>
                        </div>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card blue">
                        <div class="kpi-header"><span class="kpi-label">Funcion√°rios</span><div class="kpi-icon" style="background:#ebf5fb; color:var(--accent);"><i class="fas fa-users"></i></div></div>
                        <div class="kpi-value" id="dashTotalFunc">--</div>
                    </div>
                    <div class="kpi-card green">
                        <div class="kpi-header"><span class="kpi-label">Horas (M√™s)</span><div class="kpi-icon" style="background:#e9f7ef; color:var(--success);"><i class="fas fa-clock"></i></div></div>
                        <div class="kpi-value" id="dashHorasExtras">--</div>
                    </div>
                    <div class="kpi-card orange">
                        <div class="kpi-header"><span class="kpi-label">Pend√™ncias</span><div class="kpi-icon" style="background:#fef5e7; color:var(--warning);"><i class="fas fa-exclamation-circle"></i></div></div>
                        <div class="kpi-value" id="dashPendencias">--</div>
                    </div>
                    <div class="kpi-card purple">
                        <div class="kpi-header"><span class="kpi-label">F√©rias Ativas</span><div class="kpi-icon" style="background:#f4ecf7; color:#9b59b6;"><i class="fas fa-plane"></i></div></div>
                        <div class="kpi-value" id="dashFerias">--</div>
                    </div>
                </div>

                <div class="content-grid">
                    <div class="card">
                        <div class="card-header"><span class="card-title">Distribui√ß√£o por Setor</span></div>
                        <div style="height:250px;"><canvas id="graficoDashboard"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">Acesso R√°pido</span></div>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <button onclick="showPage('ferias')" class="btn-base btn-outline">
                                <div class="btn-icon-wrapper" style="background:#e8f8f5; color:#1abc9c;"><i class="fas fa-umbrella-beach"></i></div>
                                <span>Solicitar F√©rias</span>
                            </button>
                            <button onclick="showPage('horas')" class="btn-base btn-outline">
                                <div class="btn-icon-wrapper" style="background:#ebf5fb; color:var(--accent);"><i class="fas fa-history"></i></div>
                                <span>Banco de Horas</span>
                            </button>
                            <button onclick="showPage('funcionarios')" class="btn-base btn-outline">
                                <div class="btn-icon-wrapper" style="background:#fef9e7; color:var(--warning);"><i class="fas fa-user-plus"></i></div>
                                <span>Novo Funcion√°rio</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="horas-page" class="page">
                <div class="header-page">
                    <h1 class="page-title">Horas Extras</h1>
                    <div class="header-controls">
                        <select id="filtroPeriodo" class="select-periodo" onchange="recarregarHorasExtras()"></select>
                        <button onclick="downloadExcel()" class="btn-base btn-small btn-excel"><i class="fas fa-file-excel"></i> Excel</button>
                        <button onclick="recarregarHorasExtras()" class="btn-base btn-small btn-primary"><i class="fas fa-sync-alt"></i> Atualizar</button>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card blue">
                        <div class="kpi-header"><span class="kpi-label">Total Acumulado</span></div>
                        <div class="kpi-value" id="totalHorasExtras">--</div>
                        <small id="periodoDisplay" style="color:var(--text-light); font-size:12px; margin-top:5px;"></small>
                    </div>
                    <div class="kpi-card green">
                        <div class="kpi-header"><span class="kpi-label">Maior Saldo</span></div>
                        <div class="kpi-value" id="colaboradorMaisHoras">--</div>
                        <div id="colaboradorChange" style="font-size:13px; font-weight:600; color:var(--text-light); margin-top:5px; display:none;"></div>
                    </div>
                </div>

                <div class="content-grid">
                    <div class="card">
                        <div class="card-header"><span class="card-title">Por Setor</span></div>
                        <div style="height:250px;"><canvas id="graficoHorasPorSetor"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">Ranking</span></div>
                        <div class="table-responsive" style="max-height:250px; overflow-y:auto;">
                            <div id="tabelaColaboradores">Carregando...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="aprovacoes-page" class="page">
                <div class="header-page">
                    <h1 class="page-title">Central de Aprova√ß√µes</h1>
                    <div style="background:var(--warning); color:white; padding:5px 15px; border-radius:20px; font-size:13px; font-weight:bold;">
                        <i class="far fa-clock"></i> Pendentes: <span id="totalHorasPendentes">00:00</span>
                    </div>
                </div>
                
                <div id="acessoNegado" style="display:none; text-align:center; padding:50px; background:white; border-radius:12px;">
                    <i class="fas fa-lock fa-3x" style="color:var(--danger); margin-bottom:20px;"></i>
                    <h3>Acesso Restrito</h3>
                    <p>Apenas gestores podem aprovar.</p>
                </div>

                <div id="containerAprovacoes" class="card">
                    <div class="card-header">
                        <span class="card-title">Solicita√ß√µes Pendentes</span>
                        <button onclick="carregarSolicitacoesPendentes()" class="btn-base btn-small btn-primary"><i class="fas fa-sync"></i></button>
                    </div>
                    <div class="table-responsive">
                        <div id="solicitacoesPendentes">
                            <div style="text-align:center; padding:20px;"><div class="spinner" style="margin:0 auto;"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ferias-page" class="page">
                <div class="header-page"><h1 class="page-title">Gest√£o de F√©rias</h1></div>
                <div class="content-grid">
                    <div class="card">
                        <div class="card-header"><span class="card-title">Nova Solicita√ß√£o</span></div>
                        <form id="formFerias" onsubmit="event.preventDefault(); solicitarFerias();">
                            <div class="form-group"><label>Colaborador</label><select id="feriasNomeColaborador" required><option>Carregando...</option></select></div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                                <div class="form-group"><label>Modelo</label><select id="modeloFerias" onchange="calcularVolta()" required><option value="30">30 dias</option><option value="20_10_venda">20 + Venda</option><option value="20_10_gozo">20 (1¬∫ Per)</option></select></div>
                                <div class="form-group"><label>In√≠cio</label><input type="date" id="dataSaida" onchange="calcularVolta()" required></div>
                            </div>
                            <div id="boxPrevisao" style="background:#fef9e7; padding:10px; border-radius:6px; margin-bottom:15px; display:none; border:1px solid #f1c40f; color:#d35400; font-size:13px;">
                                <strong>Retorno: <span id="textoDataRetorno">--/--/--</span></strong><br><span id="textoDiasGozo"></span>
                                <input type="hidden" id="dataRetornoCalculada">
                            </div>
                            <div class="form-group"><label>Obs</label><textarea id="obsFerias" rows="2"></textarea></div>
                            <div style="display:flex; gap:10px;">
                                <button type="submit" id="btnSalvarFerias" class="btn-base btn-small btn-primary" style="flex:1;">Agendar</button>
                                <button type="button" onclick="abrirEmailRH()" class="btn-base btn-small btn-outline" style="flex:1;">E-mail</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">Hist√≥rico</span></div>
                        <div id="historicoFeriasContainer">Selecione um colaborador...</div>
                    </div>
                </div>
            </div>

            <div id="funcionarios-page" class="page">
                <div class="header-page">
                    <h1 class="page-title">Funcion√°rios</h1>
                    <button onclick="document.getElementById('modalFuncionario').style.display='flex'" class="btn-base btn-small btn-success"><i class="fas fa-plus"></i> Novo</button>
                </div>
                <div class="card">
                    <div class="table-responsive" id="funcionariosContainer">Carregando...</div>
                </div>
            </div>

            <div id="modalFuncionario" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; backdrop-filter:blur(2px);">
                <div style="background:white; padding:30px; border-radius:12px; width:90%; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.2); animation:fadeIn 0.3s;">
                    <h2 style="margin-bottom:20px; color:var(--primary);">Novo Funcion√°rio</h2>
                    <form onsubmit="event.preventDefault(); salvarFuncionario();">
                        <div class="form-group"><label>Nome</label><input id="inputNome" required></div>
                        <div class="form-group"><label>Cargo</label><input id="inputCargo"></div>
                        <div class="form-group"><label>Setor</label><input id="inputSetor"></div>
                        <div class="form-group"><label>Turno</label><input id="inputTurno"></div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn-base btn-small btn-success" style="flex:1;">Salvar</button>
                            <button type="button" onclick="document.getElementById('modalFuncionario').style.display='none'" class="btn-base btn-small btn-danger" style="flex:1;">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <script>
        // CONFIGURA√á√ÉO
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbynGbTG6cjnpYgUqwV9ebfvYi7AnCEZThJtOvjXHLZFuQjQNK9xBU__wtlFzdxJ6jg/exec';
        const INACTIVITY_TIMEOUT = 300000; 
        let inactivityTimer, dashboardChartInstance = null, horasChartInstance = null;

        // ===== INIT =====
        function init() { preencherPeriodos(); }

        // ===== FILTROS (M√äS SEGUINTE INCLUSO) =====
        function preencherPeriodos() {
            const sel = document.getElementById('filtroPeriodo'); if(!sel) return; sel.innerHTML='';
            const hj = new Date();
            const meses = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
            
            // L√≥gica: Se dia >= 20, libera o m√™s seguinte
            let offset = (hj.getDate() >= 20) ? 1 : 0;

            for(let i=0; i<12; i++) {
                let d = new Date(hj.getFullYear(), hj.getMonth() + offset - i, 1);
                let opt = document.createElement('option');
                opt.value = `${d.getMonth()}-${d.getFullYear()}`;
                opt.text = `${meses[d.getMonth()]}/${d.getFullYear()}`;
                sel.add(opt);
            }
        }

        // ===== EXCEL =====
        async function downloadExcel() {
            const val = document.getElementById('filtroPeriodo').value;
            if(!val) return alert("Selecione um per√≠odo.");
            const [m,a] = val.split('-');
            
            const btn = document.querySelector('.btn-excel');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Baixando...';
            btn.disabled = true;

            try {
                const res = await fetch(`${SCRIPT_URL}?action=exportarExcel&mes=${m}&ano=${a}`);
                const data = await res.json();
                if(data.sucesso) {
                    const blob = new Blob(["\ufeff" + data.dados.csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = data.dados.nomeArquivo;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else alert(data.mensagem);
            } catch(e) { alert("Erro conex√£o"); }
            finally { btn.innerHTML = originalHTML; btn.disabled = false; }
        }

        // ===== HORAS EXTRAS =====
        async function recarregarHorasExtras() {
            try {
                const val = document.getElementById('filtroPeriodo').value;
                let url = `${SCRIPT_URL}?action=obterDadosHorasExtras`;
                if(val) { const [m, a] = val.split('-'); url += `&mes=${m}&ano=${a}`; }

                const res = await fetch(url);
                const data = await res.json();
                
                if(data.sucesso) {
                    document.getElementById('totalHorasExtras').textContent = data.dados.totalHoras;
                    document.getElementById('periodoDisplay').textContent = "Ciclo: " + data.dados.periodo;
                    
                    if(data.dados.colaboradorMaisHoras) {
                        document.getElementById('colaboradorMaisHoras').textContent = data.dados.colaboradorMaisHoras.horas;
                        const el = document.getElementById('colaboradorChange');
                        el.textContent = data.dados.colaboradorMaisHoras.nome;
                        el.style.display = 'block';
                    }
                    renderChartHoras(data.dados.horasPorSetor);

                    let html = '<table><thead><tr><th style="width:50px">#</th><th>Nome</th><th>Horas</th></tr></thead><tbody>';
                    if(data.dados.ranking && data.dados.ranking.length) {
                        data.dados.ranking.forEach((c, i) => {
                            let badge = i<3 ? `<span class="rank-badge rank-${i+1}">${i+1}</span>` : `<span style="font-weight:bold; color:#bdc3c7; margin-left:8px;">${i+1}</span>`;
                            html += `<tr><td>${badge}</td><td>${c.nome}</td><td style="font-weight:bold; color:var(--primary);">${c.horas}</td></tr>`;
                        });
                    } else html += '<tr><td colspan="3">Sem registros.</td></tr>';
                    document.getElementById('tabelaColaboradores').innerHTML = html + '</tbody></table>';
                }
            } catch(e) { console.error(e); }
        }

        function renderChartHoras(setores) {
            const ctx = document.getElementById('graficoHorasPorSetor'); if(!ctx) return;
            if(!setores || !setores.length) { if(horasChartInstance) horasChartInstance.destroy(); return; }
            const labels = setores.map(s=>s.setor); const vals = setores.map(s=>s.minutos);
            if(horasChartInstance) horasChartInstance.destroy();
            horasChartInstance = new Chart(ctx, { type:'bar', data:{labels:labels, datasets:[{label:'Minutos', data:vals, backgroundColor:'#3498db', borderRadius:4}]}, options:{maintainAspectRatio:false, plugins:{legend:{display:false}, tooltip:{callbacks:{label:function(c){let m=c.raw; return `${Math.floor(m/60)}:${String(Math.round(m%60)).padStart(2,'0')} hs`;}}}}, scales:{y:{beginAtZero:true}}} });
        }

        // ===== APROVA√á√ïES (UX OTIMIZADA) =====
        async function carregarSolicitacoesPendentes() {
            const div = document.getElementById('solicitacoesPendentes');
            if(div.innerHTML.trim() === '' || div.innerHTML.includes('spinner')) {
                div.innerHTML = '<div style="text-align:center; padding:20px;"><div class="spinner"></div></div>';
            }
            try {
                const res = await fetch(`${SCRIPT_URL}?action=obterSolicitacoesPendentes`);
                const data = await res.json();
                if(data.sucesso) {
                    document.getElementById('totalHorasPendentes').textContent = data.dados.totalHoras;
                    if(!data.dados.solicitacoes || !data.dados.solicitacoes.length) {
                        div.innerHTML = '<div style="text-align:center; padding:20px; color:#95a5a6;">Tudo em dia! Nenhuma solicita√ß√£o pendente.</div>';
                        return;
                    }
                    let html = '<table><thead><tr><th>Nome</th><th>Data</th><th>Horas</th><th>A√ß√µes</th></tr></thead><tbody>';
                    data.dados.solicitacoes.forEach(s => {
                        html += `<tr><td>${s.nome}</td><td>${s.data.split('T')[0]}</td><td style="font-weight:bold;">${s.horas}</td>
                        <td><button onclick="acaoAprovar('${s.linha}', this)" class="btn-base btn-small btn-success"><i class="fas fa-check"></i></button> 
                        <button onclick="acaoRejeitar('${s.linha}', this)" class="btn-base btn-small btn-danger"><i class="fas fa-times"></i></button></td></tr>`;
                    });
                    div.innerHTML = html + '</tbody></table>';
                }
            } catch(e) { console.error(e); }
        }

        async function acaoAprovar(lin, btn) {
            if(!confirm('Aprovar?')) return;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            btn.closest('tr').classList.add('row-processing');
            await fetch(`${SCRIPT_URL}?action=aprovarSolicitacao&linha=${lin}&emailAprovador=${localStorage.getItem('userEmail')}`);
            carregarSolicitacoesPendentes();
        }
        async function acaoRejeitar(lin, btn) {
            const m = prompt('Motivo:'); if(!m) return;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            btn.closest('tr').classList.add('row-processing');
            await fetch(`${SCRIPT_URL}?action=rejeitarSolicitacao&linha=${lin}&emailAprovador=${localStorage.getItem('userEmail')}&motivo=${encodeURIComponent(m)}`);
            carregarSolicitacoesPendentes();
        }

        // ===== OUTROS =====
        async function loadDashboardData() {
            const u = localStorage.getItem('userName'); if(u) document.getElementById('dashUserName').textContent = u.split(' ')[0];
            document.getElementById('dataAtual').textContent = new Date().toLocaleDateString('pt-BR');
            try {
                const resFunc = await fetch(`${SCRIPT_URL}?action=obterFuncionarios`); const dFunc = await resFunc.json();
                if(dFunc.sucesso) {
                    document.getElementById('dashTotalFunc').textContent = dFunc.dados.funcionarios.length;
                    let sets = {}; dFunc.dados.funcionarios.forEach(f=>{ let s=f.setor||'Geral'; sets[s]=(sets[s]||0)+1; });
                    const ctx = document.getElementById('graficoDashboard');
                    if(dashboardChartInstance) dashboardChartInstance.destroy();
                    dashboardChartInstance = new Chart(ctx, { type:'doughnut', data:{labels:Object.keys(sets), datasets:[{data:Object.values(sets), backgroundColor:['#3498db','#e74c3c','#2ecc71','#f1c40f','#9b59b6'], borderWidth:0}]}, options:{responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{position:'right'}}} });
                }
                const resH = await fetch(`${SCRIPT_URL}?action=obterDadosHorasExtras`); const dH = await resH.json();
                if(dH.sucesso) document.getElementById('dashHorasExtras').textContent = dH.dados.totalHoras;
                const resP = await fetch(`${SCRIPT_URL}?action=obterSolicitacoesPendentes`); const dP = await resP.json();
                if(dP.sucesso) document.getElementById('dashPendencias').textContent = dP.dados.totalHoras;
                document.getElementById('dashFerias').textContent = '--';
            } catch(e) {}
        }

        async function carregarSelectFuncionarios() {
            const sel = document.getElementById('feriasNomeColaborador'); sel.innerHTML = '<option>Carregando...</option>';
            const res = await fetch(`${SCRIPT_URL}?action=obterFuncionarios`); const d = await res.json();
            if(d.sucesso) { sel.innerHTML='<option value="">Selecione...</option>'; d.dados.funcionarios.forEach(f=>{ let o=document.createElement('option'); o.value=f.nome; o.text=f.nome; sel.appendChild(o); }); }
        }
        function calcularVolta() {
            const s=document.getElementById('dataSaida').value; const m=document.getElementById('modeloFerias').value; if(!s||!m) {document.getElementById('boxPrevisao').style.display='none'; return;}
            let d = m=='30'?30:(m=='15_9_7'?15:20); const dt = new Date(s+'T00:00:00'); if(dt.getDay()==5) alert("Evite Sexta-feira!");
            const ret = new Date(dt); ret.setDate(dt.getDate()+d);
            document.getElementById('textoDataRetorno').textContent = ret.toLocaleDateString('pt-BR'); document.getElementById('textoDiasGozo').textContent = `${d} dias de gozo`;
            document.getElementById('dataRetornoCalculada').value = ret.toISOString().split('T')[0]; document.getElementById('boxPrevisao').style.display='block';
        }
        async function solicitarFerias() {
            const btn=document.getElementById('btnSalvarFerias'); btn.disabled=true; btn.textContent='Enviando...';
            try { await fetch(`${SCRIPT_URL}?action=agendarFerias&email=${encodeURIComponent(document.getElementById('feriasNomeColaborador').value)}&modelo=${document.getElementById('modeloFerias').value}&dataSaida=${document.getElementById('dataSaida').value}&dataRetorno=${document.getElementById('dataRetornoCalculada').value}&obs=${encodeURIComponent(document.getElementById('obsFerias').value)}`); alert('‚úÖ Agendado!'); document.getElementById('formFerias').reset(); document.getElementById('boxPrevisao').style.display='none'; carregarHistoricoFerias(); } 
            catch(e){alert('Erro');} finally{btn.disabled=false; btn.textContent='Agendar';}
        }
        async function carregarHistoricoFerias() {
            const d = document.getElementById('historicoFeriasContainer'); d.innerHTML='<div class="spinner" style="width:20px;height:20px;margin:0 auto;"></div>';
            const res = await fetch(`${SCRIPT_URL}?action=obterMinhasFerias&email=${encodeURIComponent(localStorage.getItem('userName'))}`); const data = await res.json();
            if(data.sucesso && data.dados.length) { let h=''; data.dados.forEach(f=>{ let c='#f39c12'; if(f.status=='Aprovada')c='#27ae60'; if(f.status=='Rejeitada')c='#c0392b'; h+=`<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><div><strong>${f.modelo}</strong><br><small>${f.saida.split('-').reverse().join('/')}</small></div><span style="color:${c}; font-weight:bold; font-size:12px;">${f.status}</span></div>`; }); d.innerHTML=h; } else d.innerHTML='<p style="text-align:center; color:#ccc;">Sem hist√≥rico.</p>';
        }
        async function verificarPermissaoAprovacao() {
            const res = await fetch(`${SCRIPT_URL}?action=verificarPermissaoAprovacao&email=${encodeURIComponent(localStorage.getItem('userEmail'))}`); const d = await res.json();
            if(d.sucesso && d.dados.podeAprovar) { document.getElementById('containerAprovacoes').style.display='block'; document.getElementById('acessoNegado').style.display='none'; carregarSolicitacoesPendentes(); }
            else { document.getElementById('containerAprovacoes').style.display='none'; document.getElementById('acessoNegado').style.display='block'; }
        }
        async function carregarFuncionarios() {
            const div = document.getElementById('funcionariosContainer'); div.innerHTML='<div style="text-align:center;"><div class="spinner"></div></div>';
            const res = await fetch(`${SCRIPT_URL}?action=obterFuncionarios`); const d = await res.json();
            if(d.sucesso) { let h='<table><thead><tr><th>Nome</th><th>Cargo</th><th>A√ß√£o</th></tr></thead><tbody>'; d.dados.funcionarios.forEach(f=>{ h+=`<tr><td>${f.nome}</td><td>${f.cargo}</td><td><button onclick="delFunc('${f.linha}')" class="btn-base btn-small btn-danger"><i class="fas fa-trash"></i></button></td></tr>`; }); div.innerHTML=h+'</tbody></table>'; }
        }
        async function salvarFuncionario() { await fetch(`${SCRIPT_URL}?action=adicionarFuncionario&nome=${encodeURIComponent(document.getElementById('inputNome').value)}&cargo=${encodeURIComponent(document.getElementById('inputCargo').value)}&setor=${encodeURIComponent(document.getElementById('inputSetor').value)}&turno=${encodeURIComponent(document.getElementById('inputTurno').value)}`); document.getElementById('modalFuncionario').style.display='none'; carregarFuncionarios(); }
        async function delFunc(l) { if(confirm('Excluir?')) await fetch(`${SCRIPT_URL}?action=deletarFuncionario&linha=${l}`); carregarFuncionarios(); }
        async function handleLogin(e) {
            e.preventDefault(); document.getElementById('loginBtn').disabled=true; document.getElementById('loadingSpinner').style.display='block';
            try { const res=await fetch(`${SCRIPT_URL}?action=validarCredenciais&email=${encodeURIComponent(document.getElementById('email').value)}&senha=${encodeURIComponent(document.getElementById('password').value)}`); const d=await res.json();
                if(d.sucesso){ localStorage.setItem('userEmail',d.dados.email); localStorage.setItem('userName',d.dados.nome); document.getElementById('userName').textContent=d.dados.nome; document.getElementById('userEmail').textContent=d.dados.email; document.getElementById('loginScreen').style.display='none'; document.getElementById('dashboardScreen').classList.add('active'); init(); loadDashboardData(); resetInactivityTimer(); } else { document.getElementById('errorMessage').textContent='Inv√°lido'; document.getElementById('errorMessage').style.display='block'; }
            } catch(e){alert('Erro');} finally{document.getElementById('loginBtn').disabled=false; document.getElementById('loadingSpinner').style.display='none';}
        }
        function handleLogout() { clearTimeout(inactivityTimer); localStorage.clear(); location.reload(); }
        function showPage(id) { resetInactivityTimer(); document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id+'-page').classList.add('active'); document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active')); if(id=='dashboard')loadDashboardData(); if(id=='ferias'){carregarSelectFuncionarios(); carregarHistoricoFerias();} if(id=='horas'){preencherPeriodos(); recarregarHorasExtras();} if(id=='aprovacoes')verificarPermissaoAprovacao(); if(id=='funcionarios')carregarFuncionarios(); }
        function resetInactivityTimer() { clearTimeout(inactivityTimer); inactivityTimer = setTimeout(handleLogout, INACTIVITY_TIMEOUT); }
        document.addEventListener('DOMContentLoaded', () => { document.addEventListener('mousemove', resetInactivityTimer); document.addEventListener('click', resetInactivityTimer); });
        function abrirEmailRH() { const n=document.getElementById('feriasNomeColaborador').value; const s=document.getElementById('dataSaida').value; window.open(`mailto:rh@empresa.com?subject=F√©rias - ${n}&body=Solicito f√©rias a partir de ${s}`); }
    </script>
</body>
</html>
