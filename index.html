<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RH Manager Enterprise</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ===== IDENTIDADE VISUAL ===== */
        :root {
            --sidebar-bg: #1e293b;
            --active-bg: #3b82f6;
            --bg-body: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sec: #64748b;
            --success: #10b981; /* Verde Aprovar */
            --danger: #ef4444;  /* Vermelho Rejeitar */
            --gray-btn: #94a3b8; /* Cinza Fechar */
            --radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* LOADING */
        #globalOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--card-bg); z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; transition: opacity 0.4s ease; }
        .spinner { width: 45px; height: 45px; border: 4px solid #f1f5f9; border-top: 4px solid var(--active-bg); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* LAYOUT */
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; padding: 25px 20px; flex-shrink: 0; }
        .main-content { flex: 1; overflow-y: auto; padding: 30px; background: var(--bg-body); }

        /* SIDEBAR COMPONENTS */
        .brand { font-size: 20px; font-weight: 700; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; color: white; }
        .menu-btn { display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px 16px; border: none; background: transparent; color: #94a3b8; font-size: 14px; font-weight: 500; border-radius: 8px; cursor: pointer; transition: 0.2s; text-align: left; margin-bottom: 5px; }
        .menu-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .menu-btn.active { background: var(--active-bg); color: white; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .user-info { margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 13px; color: #94a3b8; }

        /* CARDS & UI */
        .page { display: none; animation: fadeIn 0.4s; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-main); }
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .card-head { font-size: 16px; font-weight: 700; color: var(--sidebar-bg); margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }

        /* FORM ELEMENTS */
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-top: 6px; margin-bottom: 15px; font-size: 14px; background: #fff; transition: 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--active-bg); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
        label { font-size: 12px; font-weight: 700; color: var(--text-sec); text-transform: uppercase; }

        /* BOTÕES ESTILIZADOS */
        .btn { padding: 12px 24px; border-radius: 8px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        
        /* Botão AGENDAR (Verde Vibrante) */
        .btn-agendar { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            color: white; 
            width: 100%; 
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }
        .btn-agendar:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4); }

        /* Botões do Modal (Foto 3) */
        .btn-action-green { background: #22c55e; color: white; flex: 1; }
        .btn-action-red { background: #ef4444; color: white; flex: 1; }
        .btn-action-gray { background: #9ca3af; color: white; flex: 1; }
        .btn-action-green:hover, .btn-action-red:hover, .btn-action-gray:hover { opacity: 0.9; }

        /* LOGIN SCREEN */
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--sidebar-bg); display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; box-shadow: var(--shadow); }

        /* MODAL POP-UP (Estilo Foto 3) */
        .modal-bg { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.6); z-index: 6000; 
            display: none; align-items: center; justify-content: center; 
            backdrop-filter: blur(4px); 
        }
        .modal-box { 
            background: white; padding: 30px; border-radius: 16px; 
            width: 500px; max-width: 90%; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-title { font-size: 20px; font-weight: 800; color: var(--sidebar-bg); margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .modal-info p { margin-bottom: 10px; font-size: 14px; color: #333; line-height: 1.5; }
        .modal-info strong { color: var(--sidebar-bg); }
        .modal-actions { display: flex; gap: 15px; margin-top: 30px; }

        /* LISTA DE HISTÓRICO */
        .history-item { 
            padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; 
            transition: background 0.2s; border-radius: 8px;
        }
        .history-item:hover { background: #f8fafc; }
        .history-name { font-weight: 700; color: var(--sidebar-bg); font-size: 14px; margin-bottom: 4px; }
        .history-meta { font-size: 12px; color: #64748b; display: flex; justify-content: space-between; }
        .status-tag { padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 11px; text-transform: uppercase; }
        .st-solicitado { background: #e0f2fe; color: #0284c7; }
        .st-aprovada { background: #dcfce7; color: #16a34a; }
        .st-rejeitada { background: #fee2e2; color: #dc2626; }

        .row { display: flex; gap: 25px; } .col-2 { flex: 2; } .col-1 { flex: 1; }
        @media (max-width: 1024px) { .row { flex-direction: column; } }
    </style>
</head>
<body>

    <div id="globalOverlay" style="display:none;">
        <div class="spinner"></div>
        <p style="margin-top:20px; color:#64748b; font-size:14px; font-weight:600;">Carregando...</p>
    </div>

    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h2 style="color:var(--sidebar-bg); margin-bottom:10px;">RH Manager</h2>
            <p style="color:#64748b; font-size:14px; margin-bottom:30px;">Faça login para acessar</p>
            <form onsubmit="handleLogin(event)">
                <div style="text-align:left;"><label>E-MAIL</label><input type="email" id="email" required></div>
                <div style="text-align:left;"><label>SENHA</label><input type="password" id="password" required></div>
                <button type="submit" class="btn btn-prim" style="width:100%; margin-top:10px; background:var(--active-bg); color:white;">ENTRAR</button>
            </form>
            <div id="loginError" style="color:var(--danger); font-size:13px; margin-top:15px; display:none;">Credenciais inválidas.</div>
        </div>
    </div>

    <div id="appContainer" class="app-container" style="display:none;">
        <aside class="sidebar">
            <div class="brand"><i class="fas fa-layer-group"></i> RH Manager</div>
            <nav style="flex:1;">
                <button class="menu-btn active" onclick="navTo('dashboard')"><i class="fas fa-home"></i> Início</button>
                <button class="menu-btn" onclick="navTo('ferias')"><i class="fas fa-plane"></i> Férias</button>
                <button class="menu-btn" onclick="navTo('documentos')"><i class="fas fa-file-alt"></i> Documentos</button>
                <button class="menu-btn" onclick="navTo('funcionarios')"><i class="fas fa-users"></i> Funcionários</button>
                <button class="menu-btn" onclick="navTo('configuracoes')"><i class="fas fa-cog"></i> Configurações</button>
            </nav>
            <div class="user-info">
                Usuário: <strong style="color:white;" id="userNameDisplay">--</strong>
                <button onclick="doLogout()" style="background:none; border:none; color:#f87171; cursor:pointer; font-weight:bold; margin-top:5px;">Sair</button>
            </div>
        </aside>

        <main class="main-content">
            
            <div id="dashboard-page" class="page active">
                <div class="page-title">Dashboard</div>
                <div class="card"><div class="card-head">Bem-vindo</div><p>Selecione uma opção no menu lateral.</p></div>
            </div>

            <div id="ferias-page" class="page">
                <div class="page-title">Gestão de Férias</div>
                <div class="row">
                    <div class="col-2 card">
                        <div class="card-head">Nova Solicitação</div>
                        <form onsubmit="event.preventDefault(); solicitarFerias()">
                            <label>COLABORADOR</label>
                            <select id="feriasColab" required><option>Carregando...</option></select>
                            
                            <div class="row" style="margin-top:15px; gap:20px;">
                                <div style="flex:1;">
                                    <label>MODELO</label>
                                    <select id="feriasModelo">
                                        <option value="30">30 dias corridos</option>
                                        <option value="20_10_venda">20 dias + Venda 10</option>
                                        <option value="20_10_gozo">20 dias (1º Período)</option>
                                        <option value="15_9_7">15 dias (1º Período)</option>
                                    </select>
                                </div>
                                <div style="flex:1;">
                                    <label>DATA DE INÍCIO</label>
                                    <input type="date" id="feriasInicio" required>
                                </div>
                            </div>

                            <label style="margin-top:15px;">OBSERVAÇÕES (OPCIONAL)</label>
                            <textarea id="feriasObs" rows="3" placeholder="Ex: Adiantamento de 13º..."></textarea>

                            <button type="submit" class="btn btn-agendar" id="btnAgendar">
                                <i class="fas fa-check-circle"></i> AGENDAR FÉRIAS
                            </button>
                        </form>
                    </div>

                    <div class="col-1 card">
                        <div class="card-head">Histórico Recente</div>
                        <div id="listaFeriasRecentes" style="max-height:500px; overflow-y:auto; padding-right:5px;">
                            <div style="text-align:center; color:#94a3b8; padding:20px;">Carregando...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="funcionarios-page" class="page"><div class="page-title">Funcionários</div><div class="card"><div id="tabelaFuncionarios"></div></div></div>
            <div id="documentos-page" class="page"><div class="page-title">Documentos</div><div class="card"><p>Emissão de documentos.</p></div></div>
            <div id="configuracoes-page" class="page"><div class="page-title">Configurações</div><div class="card"><p>Ajustes de sistema.</p></div></div>

        </main>
    </div>

    <div id="modalDetalhes" class="modal-bg">
        <div class="modal-box">
            <div class="modal-title">Detalhes da Solicitação</div>
            
            <div id="conteudoModalDetalhes" class="modal-info">
                </div>
            
            <input type="hidden" id="hdnIdFerias">
            <input type="hidden" id="hdnDadosFerias">

            <div class="modal-actions">
                <button onclick="acaoFerias('Aprovada')" class="btn btn-action-green">Aprovar</button>
                <button onclick="acaoFerias('Rejeitada')" class="btn btn-action-red">Rejeitar</button>
                <button onclick="document.getElementById('modalDetalhes').style.display='none'" class="btn btn-action-gray">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // === LINK DO SCRIPT ===
        const API_URL = 'https://script.google.com/macros/s/AKfycbyHjBXunS93unrWEFC2B-yFUmb3swvXUR0c0CGFe9-oUifZz3kY_GHa4-KtDRVXhbLl/exec';

        // INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', () => {
            localStorage.clear();
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        });

        // LOGIN
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.querySelector('#loginScreen button'); btn.disabled=true; btn.innerText="...";
            document.getElementById('globalOverlay').style.display='flex';
            
            const em = document.getElementById('email').value; const pw = document.getElementById('password').value;
            try {
                const res = await fetch(`${API_URL}?action=validarCredenciais&email=${encodeURIComponent(em)}&senha=${encodeURIComponent(pw)}`);
                const d = await res.json();
                setTimeout(() => {
                    if (d.sucesso) {
                        localStorage.setItem('u_email', d.dados.email); localStorage.setItem('u_nome', d.dados.nome);
                        document.getElementById('userNameDisplay').innerText = d.dados.nome;
                        document.getElementById('loginScreen').style.display='none';
                        document.getElementById('appContainer').style.display='flex';
                        initApp();
                        document.getElementById('globalOverlay').style.display='none';
                    } else {
                        document.getElementById('globalOverlay').style.display='none';
                        document.getElementById('loginError').style.display='block';
                        document.getElementById('loginError').innerText = d.mensagem;
                    }
                    btn.disabled=false; btn.innerText="ENTRAR";
                }, 1000);
            } catch(x) { alert("Erro conexão."); document.getElementById('globalOverlay').style.display='none'; btn.disabled=false; }
        }

        function doLogout() { localStorage.clear(); location.reload(); }
        function initApp() { carregarColabs(); }

        function navTo(id) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(id+'-page').classList.add('active');
            const btn = Array.from(document.querySelectorAll('.menu-btn')).find(b => b.getAttribute('onclick').includes(id));
            if(btn) btn.classList.add('active');
            
            if(id=='ferias') { carregarColabs(); carregarListaFerias(); }
            if(id=='funcionarios') carregarFuncionarios();
        }

        // --- FÉRIAS ---
        async function carregarColabs() {
            const res = await fetch(`${API_URL}?action=obterFuncionarios`); const d = await res.json();
            const ops = d.dados.funcionarios.map(f => `<option value="${f.nome}">${f.nome}</option>`).join('');
            document.getElementById('feriasColab').innerHTML = ops;
        }

        async function solicitarFerias() {
            const btn = document.getElementById('btnAgendar'); btn.disabled=true; btn.innerText='...';
            await fetch(`${API_URL}?action=agendarFerias&email=${encodeURIComponent(document.getElementById('feriasColab').value)}&modelo=${document.getElementById('feriasModelo').value}&dataSaida=${document.getElementById('feriasInicio').value}&obs=${encodeURIComponent(document.getElementById('feriasObs').value)}`);
            alert('Sucesso!'); btn.disabled=false; btn.innerHTML='<i class="fas fa-check-circle"></i> AGENDAR FÉRIAS'; carregarListaFerias();
        }

        async function carregarListaFerias() {
            const div = document.getElementById('listaFeriasRecentes'); div.innerHTML='<div style="text-align:center;color:#999;padding:20px;">Carregando...</div>';
            const res = await fetch(`${API_URL}?action=obterTodasFerias`); const d = await res.json();
            
            if(d.sucesso && d.dados.length) {
                div.innerHTML = d.dados.map(f => {
                    let stClass = 'st-solicitado';
                    if(f.status === 'Aprovada') stClass = 'st-aprovada';
                    if(f.status === 'Rejeitada') stClass = 'st-rejeitada';

                    return `
                    <div class="history-item" onclick='verDetalhesFerias(${JSON.stringify(f)})'>
                        <div class="history-name">${f.colaborador}</div>
                        <div class="history-meta">
                            <span>${formatDataBr(f.saida)}</span>
                            <span class="status-tag ${stClass}">${f.status}</span>
                        </div>
                    </div>`;
                }).join('');
            } else {
                div.innerHTML='<div style="text-align:center;color:#999;padding:20px;">Nenhuma solicitação.</div>';
            }
        }

        function verDetalhesFerias(f) {
            document.getElementById('hdnIdFerias').value = f.linha;
            document.getElementById('conteudoModalDetalhes').innerHTML = `
                <p><strong>Colaborador:</strong> ${f.colaborador}</p>
                <p><strong>Modelo:</strong> ${f.modelo}</p>
                <p><strong>Saída:</strong> ${formatDataBr(f.saida)}</p>
                <p><strong>Retorno (Previsto):</strong> ${formatDataBr(f.retorno)}</p>
                <p><strong>Obs:</strong> ${f.obs || '-'}</p>
                <p><strong>Status Atual:</strong> ${f.status}</p>
            `;
            document.getElementById('modalDetalhes').style.display = 'flex';
        }

        async function acaoFerias(st) {
            const ln = document.getElementById('hdnIdFerias').value;
            let m = '';
            if(st === 'Rejeitada') {
                m = prompt('Motivo da rejeição:');
                if(!m) return; // Cancela se não digitar motivo
            }
            
            document.getElementById('modalDetalhes').style.display = 'none';
            
            // Loading rápido visual na lista
            document.getElementById('listaFeriasRecentes').innerHTML = '<div style="text-align:center;padding:20px;">Atualizando...</div>';
            
            await fetch(`${API_URL}?action=alterarStatusFerias&linha=${ln}&status=${st}&motivo=${encodeURIComponent(m)}&emailUser=${localStorage.getItem('u_email')}`);
            carregarListaFerias();
        }

        function formatDataBr(d) { if(!d)return ""; if(d.includes('/'))return d; const p=d.split('-'); if(p.length===3)return `${p[2]}/${p[1]}/${p[0]}`; return d; }
        
        // --- FUNCIONÁRIOS (Simplificado para o exemplo) ---
        async function carregarFuncionarios() {
            const div = document.getElementById('tabelaFuncionarios'); div.innerHTML='Carregando...';
            const res = await fetch(`${API_URL}?action=obterFuncionarios`); const d = await res.json();
            div.innerHTML = '<table width="100%"><tr><th>Nome</th><th>Cargo</th></tr>' + d.dados.funcionarios.map(f=>`<tr><td>${f.nome}</td><td>${f.cargo}</td></tr>`).join('') + '</table>';
        }

    </script>
</body>
</html>
